<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- SEO Meta Tags -->
    <title>
      Admin Dashboard - Vikas Public School | Content Management System
    </title>
    <meta
      name="description"
      content="Secure admin dashboard for Vikas Public School content management. Manage faculty, events, gallery, testimonials and school information."
    />
    <meta name="robots" content="noindex, nofollow" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://vikaspublicschool.edu/admin.html" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="alternate icon" href="assets/favicon.svg" />
    <link rel="apple-touch-icon" href="assets/logo.png" />
    <!-- Firebase SDKs - Optimized for Spark Plan -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
      :root {
        --primary-color: #3b82f6;
        --primary-dark: #1e40af;
        --primary-light: #dbeafe;
        --secondary-color: #64748b;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --background: #f8fafc;
        --surface: #ffffff;
        --border: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--background);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        color: var(--text-primary);
        line-height: 1.6;
      }

      .app-container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 280px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        padding: 1.5rem;
        overflow-y: auto;
        transition: transform 0.3s ease;
      }

      .sidebar.mobile-hidden {
        transform: translateX(-100%);
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
      }

      .sidebar-header .logo {
        width: 32px;
        height: 32px;
        background: var(--primary-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .sidebar-header h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .nav-section {
        margin-bottom: 2rem;
      }

      .nav-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        margin-bottom: 0.25rem;
        font-weight: 500;
      }

      .nav-item:hover {
        background: var(--primary-light);
        color: var(--primary-color);
      }

      .nav-item.active {
        background: var(--primary-color);
        color: white;
      }

      .nav-item .icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .mobile-menu-btn:hover {
        background: var(--primary-light);
      }

      .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .mode-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        background: var(--success-color);
        color: white;
      }

      .mode-badge.local {
        background: var(--warning-color);
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 8px;
        background: var(--background);
        border: 1px solid var(--border);
      }

      .content-area {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
      }
      .card {
        background: var(--surface);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 1.5rem;
      }

      .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .card-content {
        padding: 1.5rem;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        white-space: nowrap;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-danger {
        background: var(--danger-color);
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
      }

      .table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface);
      }

      .table th {
        background: var(--background);
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border);
      }

      .table td {
        padding: 1rem 0.75rem;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }

      .table tr:last-child td {
        border-bottom: none;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.375rem;
      }

      .form-input {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: var(--surface);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
      }

      .form-textarea {
        min-height: 80px;
        resize: vertical;
      }

      .image-upload-section {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
      }

      .current-image {
        text-align: center;
        margin-bottom: 1rem;
      }

      .current-image img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .upload-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .form-input[type="file"] {
        padding: 0.5rem;
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
      }

      .form-input[type="file"]:hover {
        border-color: var(--primary-color);
      }

      small {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .image-upload-area {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .image-upload-area:hover {
        border-color: var(--primary-color);
        background: var(--primary-light);
      }

      .image-preview {
        max-width: 120px;
        max-height: 120px;
        border-radius: 8px;
        border: 1px solid var(--border);
        object-fit: cover;
      }

      .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
        margin: 0.5rem 0;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.3s ease;
      }

      .success-toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: var(--success-color);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      }

      .success-toast.show {
        opacity: 1;
        transform: translateX(0);
      }

      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--background);
        padding: 1rem;
      }

      .login-card {
        background: var(--surface);
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border);
        width: 100%;
        max-width: 400px;
        overflow: hidden;
      }

      .login-header {
        padding: 2rem 1.5rem 1rem;
        text-align: center;
      }

      .login-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 0.5rem;
      }

      .login-subtitle {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .login-form {
        padding: 0 1.5rem 2rem;
      }

      .login-status {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        text-align: center;
      }

      .login-status.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .login-status.success {
        background: #f0fdf4;
        color: #16a34a;
        border: 1px solid #bbf7d0;
      }

      .login-status.loading {
        background: #f8fafc;
        color: var(--text-secondary);
        border: 1px solid var(--border);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          height: 100vh;
          z-index: 50;
          transform: translateX(-100%);
        }

        .sidebar.mobile-visible {
          transform: translateX(0);
        }

        .mobile-menu-btn {
          display: block;
        }

        .content-area {
          padding: 1rem;
        }

        .card-header {
          padding: 1rem;
        }

        .card-content {
          padding: 1rem;
        }

        .table th,
        .table td {
          padding: 0.5rem;
          font-size: 0.875rem;
        }

        .page-title {
          font-size: 1.25rem;
        }
      }

      @media (max-width: 640px) {
        .header {
          padding: 1rem;
        }

        .table-container {
          overflow-x: scroll;
        }

        .btn {
          padding: 0.5rem 0.75rem;
          font-size: 0.75rem;
        }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* FAQ Management Styles */
      .faq-item {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.2s ease;
      }

      .faq-item:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-1px);
      }

      .faq-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border);
      }

      .faq-header h4 {
        margin: 0;
        color: var(--primary-color);
        font-weight: 600;
      }

      .faq-actions {
        display: flex;
        gap: 0.5rem;
      }

      .faq-actions .btn {
        min-width: auto;
        padding: 0.25rem 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
      <div class="login-card">
        <div class="login-header">
          <h1 class="login-title">Admin Portal</h1>
          <p class="login-subtitle">Manage your school website content</p>
        </div>
        <form class="login-form" onsubmit="return false;">
          <div class="form-group">
            <label class="form-label" for="login-email">Email Address</label>
            <input
              type="email"
              id="login-email"
              class="form-input"
              placeholder="admin@vpschool.com"
              value="admin@vpschool.com"
            />
          </div>
          <div class="form-group">
            <label class="form-label" for="login-password">Password</label>
            <input
              type="password"
              id="login-password"
              class="form-input"
              placeholder="Enter your password"
            />
          </div>
          <button
            type="button"
            onclick="login()"
            class="btn btn-primary"
            style="width: 100%"
          >
            <span class="icon">🔑</span>
            Sign In
          </button>
          <div
            id="login-status"
            class="login-status"
            style="display: none"
          ></div>
        </form>
      </div>
    </div>

    <!-- Main App -->
    <div id="admin-app" class="app-container" style="display: none">
      <!-- Sidebar -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">VP</div>
          <h1>VPS Admin</h1>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Content Management</div>
          <a
            class="nav-item active"
            onclick="showSection('faculty')"
            id="nav-faculty"
          >
            <span class="icon">👥</span>
            Faculty
          </a>
          <a class="nav-item" onclick="showSection('gallery')" id="nav-gallery">
            <span class="icon">🖼️</span>
            Gallery
          </a>
          <a
            class="nav-item"
            onclick="showSection('testimonials')"
            id="nav-testimonials"
          >
            <span class="icon">💬</span>
            Testimonials
          </a>
          <a class="nav-item" onclick="showSection('events')" id="nav-events">
            <span class="icon">📌</span>
            Notice Board
          </a>
          <a
            class="nav-item"
            onclick="showSection('academics')"
            id="nav-academics"
          >
            <span class="icon">📚</span>
            Academics
          </a>
          <a class="nav-item" onclick="showSection('faq')" id="nav-faq">
            <span class="icon">❓</span>
            FAQ Management
          </a>
          <a class="nav-item" onclick="showSection('hero')" id="nav-hero">
            <span class="icon">🏠</span>
            Homepage Hero
          </a>
          <a class="nav-item" onclick="showSection('about')" id="nav-about">
            <span class="icon">ℹ️</span>
            About Section
          </a>
          <a
            class="nav-item"
            onclick="showSection('disclosure')"
            id="nav-disclosure"
          >
            <span class="icon">📄</span>
            Mandatory Disclosure
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <a class="nav-item" onclick="showSection('logo')" id="nav-logo">
            <span class="icon">🖼️</span>
            School Logo
          </a>
          <a
            class="nav-item"
            onclick="showSection('school-info')"
            id="nav-school-info"
          >
            <span class="icon">🏫</span>
            School Info
          </a>
          <a class="nav-item" onclick="showSection('contact')" id="nav-contact">
            <span class="icon">📞</span>
            Contact Details
          </a>
        </div>
      </nav>

      <!-- Overlay for mobile -->
      <div class="overlay" id="overlay" onclick="toggleMobileMenu()"></div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="header-left">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
              <span class="icon"></span>
            </button>
            <h1 class="page-title" id="page-title">Faculty Management</h1>
          </div>
          <div class="header-right">
            <div class="mode-badge" id="mode-badge">Firebase Mode</div>
            <div class="user-menu">
              <span id="user-email">admin@vpschool.com</span>
              <button class="btn btn-sm" onclick="logout()">Logout</button>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <div class="content-area" id="content-area">
          <!-- Content sections will be loaded here -->
        </div>
      </main>
    </div>

    <script>
      // Debug Firebase loading
      console.log("Firebase scripts loaded, initializing...");

      // Firebase Free Tier Optimization Settings
      const BYPASS_AUTH = false; // Set to true only for local testing without Firebase
      const USE_CACHE = true; // Enable offline caching for free tier efficiency

      // Firebase config and initialization
      const firebaseConfig = {
        apiKey: "AIzaSyDZH0ZcGAtrILqdRdI5dIhZCUA0eAJzRpE",
        authDomain: "vpschool-918d6.firebaseapp.com",
        projectId: "vpschool-918d6",
        storageBucket: "vpschool-918d6.firebasestorage.app",
        messagingSenderId: "290237090155",
        appId: "1:290237090155:web:90356cb12d25d5a0a8a42e",
        measurementId: "G-02JK84S8NH",
      };

      // Initialize Firebase with free tier optimizations
      let db, storage, auth;
      try {
        console.log("Starting Firebase initialization...");

        // Check if Firebase is already initialized
        let app;
        try {
          app = firebase.app();
          console.log("Firebase already initialized, using existing app");
        } catch (e) {
          app = firebase.initializeApp(firebaseConfig);
          console.log("Firebase app initialized");
        }

        // Initialize Firestore with cache settings for free tier
        db = firebase.firestore();

        // Enable offline persistence (free tier friendly)
        if (USE_CACHE) {
          db.enablePersistence({ synchronizeTabs: true })
            .then(() => {
              console.log(
                "Firestore persistence enabled - reduces reads on free tier!"
              );
            })
            .catch((err) => {
              if (err.code == "failed-precondition") {
                console.log(
                  "Multiple tabs open, persistence can only be enabled in one tab at a time."
                );
              } else if (err.code == "unimplemented") {
                console.log(
                  "The current browser does not support persistence."
                );
              }
            });
        }

        console.log("Firestore initialized");

        // Skip Firebase Storage initialization (not needed for Spark plan)
        storage = null;
        console.log("Skipping Firebase Storage - using local assets folder");

        auth = firebase.auth();
        console.log("Storage initialized");

        auth = firebase.auth();
        console.log("Auth initialized");

        // Test Firebase connection with minimal reads
        if (!BYPASS_AUTH) {
          console.log("Testing Firebase connection...");
          db.enableNetwork()
            .then(() => {
              console.log("Firestore network enabled successfully");
            })
            .catch((error) => {
              console.error("Firestore network error:", error);
              alert(
                "Firebase connection failed. Please check your Firebase setup."
              );
            });
        }

        console.log(
          "Firebase initialized successfully with free tier optimizations"
        );
      } catch (error) {
        console.error("Firebase initialization error:", error);
        alert(
          "Firebase initialization failed: " +
            error.message +
            "\n\nSwitching to local mode for now."
        );
      }

      // Data holders for all website sections
      let facultyData = [];
      let galleryData = [];
      let testimonialsData = [];
      let eventsData = [];
      let faqData = [
        {
          id: "faq1",
          question: "What is the admission process?",
          answer:
            "We have an application followed by an entrance test and interview. Detailed steps are available in the Admissions section.",
        },
        {
          id: "faq2",
          question: "Do you offer transportation facilities?",
          answer:
            "Yes, we provide safe and reliable transport services covering major areas of the region.",
        },
        {
          id: "faq3",
          question: "What co-curricular activities are available?",
          answer:
            "Students can participate in sports, music, dance, arts, debate, coding clubs, and more.",
        },
      ];
      let academicsData = {
        description:
          "At Vikas Public School, we offer a comprehensive curriculum that nurtures academic excellence and critical thinking skills.",
        curriculum: "CBSE syllabus from Nursery to Class XII.",
        programs: "STEM initiatives, Coding clubs, Language enrichment.",
        assessment:
          "Continuous Evaluation, Project Based Learning, Olympiads preparation.",
        extracurricular:
          "Art, Music, Dance, Debate, and Sports to nurture talents.",
      };
      let heroData = {
        title: "Vikas Public School",
        subtitle: "Excellence in Education",
        backgroundImage: "",
      };
      let aboutData = {
        content:
          "Vikas Public School, established in 2004, is committed to nurturing young minds through holistic education. Our mission is to foster intellectual curiosity, critical thinking, and responsible citizenship through a dynamic curriculum and dedicated faculty.",
        leadership: [
          {
            id: "manager",
            name: "Jatashankar Pal",
            position: "Manager",
            description:
              "Leading the institution with vision and dedication to excellence in education.",
            image: "assets/IMG-20250726-WA0016.jpg",
          },
          {
            id: "principal",
            name: "Principal",
            position: "Principal",
            description:
              "Committed to fostering academic excellence and character development.",
            image: "assets/IMG-20250726-WA0017.jpg",
          },
        ],
        highlights: [
          {
            id: "cbse",
            icon: "🏛️",
            title: "CBSE Affiliation",
            description: "Accredited standards ensuring quality education",
          },
          {
            id: "campus",
            icon: "🏫",
            title: "Modern Campus",
            description:
              "Smart classrooms, libraries, science labs, and sports facilities",
          },
          {
            id: "development",
            icon: "🎯",
            title: "Holistic Development",
            description:
              "Focus on academics, co-curricular activities, and personal growth",
          },
          {
            id: "environment",
            icon: "🛡️",
            title: "Safe Environment",
            description:
              "Inclusive and secure learning atmosphere for all students",
          },
        ],
      };
      let logoData = {
        logoUrl: "assets/logo.png",
        schoolName: "Vikas Public School",
        tagline: "Excellence in Education",
      };
      let schoolInfoData = {
        name: "Vikas Public School",
        address: "",
        phone: "",
        email: "",
      };
      let contactData = { address: "", phone: "", email: "", hours: "" };
      // Disclosure data holder (global)
      let disclosureData = {};

      // Current section
      let currentSection = "disclosure"; // Set default to 'disclosure' for debugging

      // Mobile menu state
      let mobileMenuOpen = false;

      // Mobile menu toggle
      function toggleMobileMenu() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");

        mobileMenuOpen = !mobileMenuOpen;

        if (mobileMenuOpen) {
          sidebar.classList.add("mobile-visible");
          overlay.classList.add("show");
        } else {
          sidebar.classList.remove("mobile-visible");
          overlay.classList.remove("show");
        }
      }

      // Section management
      function showSection(section) {
        // Update navigation
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document.getElementById(`nav-${section}`).classList.add("active");

        // Update page title
        const titles = {
          faculty: "Faculty Management",
          gallery: "Gallery Management",
          testimonials: "Testimonials Management",
          events: "Notice Board Management",
          academics: "Academics Management",
          faq: "FAQ Management",
          hero: "Homepage Hero",
          about: "About Section",
          logo: "School Logo Management",
          "school-info": "School Information",
          contact: "Contact Details",
          disclosure: "Mandatory Public Disclosure",
        };
        document.getElementById("page-title").textContent = titles[section];

        currentSection = section;
        renderSection(section);

        // Close mobile menu
        if (mobileMenuOpen) {
          toggleMobileMenu();
        }
      }

      // Render different sections
      function renderSection(section) {
        const contentArea = document.getElementById("content-area");

        switch (section) {
          case "faculty":
            renderFacultySection();
            break;
          case "gallery":
            renderGallerySection();
            break;
          case "testimonials":
            renderTestimonialsSection();
            break;
          case "events":
            renderEventsSection();
            break;
          case "academics":
            renderAcademicsSection();
            break;
          case "faq":
            renderFaqSection();
            break;
          case "hero":
            renderHeroSection();
            break;
          case "about":
            renderAboutSection();
            break;
          case "logo":
            renderLogoSection();
            break;
          case "school-info":
            renderSchoolInfoSection();
            break;
          case "contact":
            renderContactSection();
            break;
          case "disclosure":
            renderDisclosureSection();
            break;
            // Mandatory Disclosure section renderer
            function renderDisclosureSection() {
              try {
                console.log("[Disclosure] renderDisclosureSection called");
                // Only use what is in Firestore; no default sections or fields
                if (!window.disclosureSections) {
                  window.disclosureSections = [];
                }
                let disclosureSections = window.disclosureSections;
                let disclosureData = window.disclosureData || {};
                // Prefill from Firestore if not already loaded
                if (!window._disclosureSectionsLoaded && db) {
                  window._disclosureSectionsLoaded = true;
                  document.getElementById("content-area").innerHTML =
                    '<div style="padding:2rem;text-align:center;">Loading disclosure data...</div>';
                  db.collection("settings")
                    .doc("disclosure")
                    .get()
                    .then((doc) => {
                      let d = doc.exists ? doc.data() : {};
                      window.disclosureSections = Array.isArray(d.sections) ? d.sections : [];
                      window.disclosureData = d.data || {};
                      disclosureData = window.disclosureData;
                      window.disclosureSectionSelected =
                        window.disclosureSectionSelected ||
                        window.disclosureSections.find((s) => s.enabled)?.id ||
                        window.disclosureSections[0]?.id || null;
                      renderDisclosureSection();
                    })
                    .catch((err) => {
                      console.error("[Disclosure] Firestore load error:", err);
                      // Fallback: render with empty sections and data
                      window.disclosureSections = [];
                      window.disclosureData = {};
                      window.disclosureSectionSelected = null;
                      renderDisclosureSection();
                    });
                  return;
                }
                // ...rest of the function as before...
              } catch (e) {
                console.error("[Disclosure] Uncaught error in renderDisclosureSection:", e);
                document.getElementById("content-area").innerHTML = '<div style="padding:2rem;text-align:center;color:red;">An unexpected error occurred in the Disclosure UI.<br>' + e.message + '</div>';
              }
              // Always select a valid section if possible
              let selected =
                window.disclosureSectionSelected && disclosureSections.some(s => s.id === window.disclosureSectionSelected)
                  ? window.disclosureSectionSelected
                  : (disclosureSections.find((s) => s.enabled)?.id || disclosureSections[0]?.id || null);
              window.disclosureSectionSelected = selected;
              // After rendering dropdown, ensure window.disclosureSectionSelected is set
              setTimeout(() => {
                const sectionSelect = document.getElementById("disclosure-section-select");
                if (sectionSelect && !window.disclosureSectionSelected) {
                  window.disclosureSectionSelected = sectionSelect.value;
                }
              }, 0);
              disclosureData = window.disclosureData || {};
              // Section Manager UI (ordered list)
              let managerHtml = `<div class="card" style="margin-bottom:2rem;"><div class="card-header"><h3 class="card-title">Disclosure Sections Manager</h3></div><div class="card-content"><ol style="padding-left:1.5rem;">`;
              disclosureSections.forEach((section, idx) => {
                managerHtml += `<li style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
      <input type="checkbox" ${section.enabled ? "checked" : ""} data-section-idx="${idx}" class="disclosure-section-enable">
      <span style="flex:1;">${section.label}</span>
      <button class="btn btn-sm" data-move="up" data-section-idx="${idx}" ${idx === 0 ? "disabled" : ""} title="Move Up">⬆️</button>
      <button class="btn btn-sm" data-move="down" data-section-idx="${idx}" ${idx === disclosureSections.length - 1 ? "disabled" : ""} title="Move Down">⬇️</button>
      <button class="btn btn-danger btn-sm" data-delete-section="${idx}" title="Delete">🗑️</button>
    </li>`;
              });
              managerHtml += `</ol><button class="btn btn-primary btn-sm" id="add-custom-section">➕ Add Custom Section</button></div></div>`;
              // Section dropdown (only enabled sections)
              const enabledSections = disclosureSections.filter((s) => s.enabled);
              const dropdown = `<div class="form-group" style="max-width:350px;margin-bottom:2rem;"><label class="form-label">Select Disclosure Section</label><select class="form-input" id="disclosure-section-select">${enabledSections.length > 0
                ? enabledSections.map(
                    (opt) =>
                      `<option value="${opt.id}"${selected === opt.id ? " selected" : ""}>${opt.label}</option>`
                  ).join("")
                : '<option disabled selected>No enabled sections</option>'}
                </select></div>`;
              let sectionHtml = "";
              // Only render custom sections and fields
              let custom = disclosureSections.find((s) => s.id === selected);
              if (custom) {
                // Always reload the latest disclosureData from window (in case it was updated by save or Firestore)
                let d = window.disclosureData && window.disclosureData[selected] ? window.disclosureData[selected] : {};
                if (!Array.isArray(custom.fields)) custom.fields = [];
                sectionHtml = `<strong>${custom.label || "Custom Section"}</strong>
      <div id="custom-fields-list">
        ${custom.fields.map((field, idx) => {
          // Always render empty if label is undefined or null
          const label = typeof field.label === 'string' ? field.label : '';
          return `
            <div class="form-group" style="display:flex;align-items:center;gap:0.5rem;">
              <input class="form-input" style="flex:2;" placeholder="Field Name" value="${label}" data-field-idx="${idx}" data-field-type="label">
              <input class="form-input" style="flex:2;" placeholder="Value" value="${label && d[label] !== undefined ? d[label] : ''}" data-field-idx="${idx}" data-field-type="value">
              <button class="btn btn-danger btn-sm" data-remove-field="${idx}" title="Remove Field">🗑️</button>
            </div>
          `;
        }).join("")}
      </div>
      <button class="btn btn-primary btn-sm" id="add-custom-field">➕ Add Field</button>`;
                // Save value changes for custom fields (update disclosureData)
                // Attach handlers for field name/value/remove after DOM update
                setTimeout(() => {
                  // Field name change
                  document.querySelectorAll('#custom-fields-list input[data-field-type="label"]').forEach((input) => {
                    input.oninput = function () {
                      const idx = +input.getAttribute('data-field-idx');
                      const oldLabel = custom.fields[idx].label;
                      const newLabel = input.value;
                      custom.fields[idx].label = newLabel;
                      if (d[oldLabel] !== undefined && oldLabel !== newLabel) {
                        d[newLabel] = d[oldLabel];
                        delete d[oldLabel];
                        window.disclosureData[selected] = d;
                        renderDisclosureSection();
                      }
                    };
                  });
                  // Field value change
                  document.querySelectorAll('#custom-fields-list input[data-field-type="value"]').forEach((input) => {
                    input.oninput = function () {
                      const idx = +input.getAttribute('data-field-idx');
                      const label = custom.fields[idx].label;
                      d[label] = input.value;
                      window.disclosureData[selected] = d;
                    };
                  });
                  // Remove field
                  document.querySelectorAll('button[data-remove-field]').forEach((btn) => {
                    btn.onclick = function () {
                      const idx = +btn.getAttribute('data-remove-field');
                      const label = custom.fields[idx].label;
                      custom.fields.splice(idx, 1);
                      if (d[label] !== undefined) delete d[label];
                      window.disclosureData[selected] = d;
                      renderDisclosureSection();
                    };
                  });
                }, 0);
                // Add field (ensure only one handler is attached, and not inside setTimeout)
                const addFieldBtn = document.getElementById('add-custom-field');
                if (addFieldBtn) {
                  addFieldBtn.onclick = null;
                  addFieldBtn.onclick = function () {
                    // Always add a truly empty field (no label, no value, no type)
                    custom.fields.push({});
                    renderDisclosureSection();
                  };
                }

              // Robustly attach dropdown and save button handlers after DOM is ready
              setTimeout(() => {
                const sectionSelect = document.getElementById("disclosure-section-select");
                if (sectionSelect) {
                  sectionSelect.onchange = function () {
                    window.disclosureSectionSelected = sectionSelect.value;
                    renderDisclosureSection();
                  };
                }
                // Always attach save button handler, regardless of section type
                const saveBtn = document.querySelector(
                  ".form-actions .btn-primary"
                );
                if (saveBtn && db) {
                  saveBtn.onclick = function () {
                    try {
                      let selected = window.disclosureSectionSelected;
                      if (!selected && sectionSelect) selected = sectionSelect.value;
                      if (!selected) {
                        alert("No section selected!");
                        return;
                      }
                      const foundSection = disclosureSections.find(s => s.id === selected);
                      if (!foundSection) {
                        alert("Section not found: " + selected);
                        return;
                      }
                      // Save only the currently selected section
                      let d = disclosureData[selected] || {};
                      if (foundSection.standard) {
                        // Standard section: gather all input values by id prefix
                        const inputs = document.querySelectorAll(`#disclosure-section-content input[id^='disclosure-']`);
                        inputs.forEach(input => {
                          // Remove 'disclosure-' and any section-specific prefix
                          let key = input.id.replace(/^disclosure-(xii-|x-)?/, '').replace(/-/g, '');
                          // Map to correct keys for each section
                          switch(selected) {
                            case 'general':
                              key = input.id.replace('disclosure-', '');
                              break;
                            case 'documents':
                              key = input.id.replace('disclosure-', '').replace(/-/g, '');
                              break;
                            case 'academics':
                              key = input.id.replace('disclosure-', '').replace(/-/g, '');
                              break;
                            case 'staff':
                              key = input.id.replace('disclosure-', '').replace(/-/g, '');
                              break;
                            case 'resultx':
                              key = input.id.replace('disclosure-x-', '');
                              break;
                            case 'resultxii':
                              key = input.id.replace('disclosure-xii-', '');
                              break;
                            case 'infra':
                              key = input.id.replace('disclosure-', '').replace(/-/g, '');
                              break;
                          }
                          d[key] = input.value;
                        });
                        disclosureData[selected] = d;
                      } else {
                        // Custom section: already updated on input, but ensure all values are gathered
                        document
                          .querySelectorAll(
                            ".custom-value-input[data-value-key]"
                          )
                          ?.forEach((input) => {
                            const key = input.getAttribute("data-value-key");
                            d[key] = input.value;
                          });
                        disclosureData[selected] = d;
                      }
                      window.disclosureData = disclosureData;
                      saveBtn.disabled = true;
                      saveBtn.innerHTML =
                        '<span class="icon">⏳</span> Saving...';
                      db.collection("settings")
                        .doc("disclosure")
                        .set({
                          sections: window.disclosureSections,
                          data: window.disclosureData,
                        })
                        .then(() => {
                          saveBtn.innerHTML =
                            '<span class="icon">✅</span> Saved!';
                          setTimeout(() => {
                            saveBtn.innerHTML =
                              '<span class="icon">💾</span> Save Disclosure Data';
                            saveBtn.disabled = false;
                            window._disclosureSectionsLoaded = false;
                            renderDisclosureSection();
                          }, 1200);
                        })
                        .catch((err) => {
                          saveBtn.innerHTML =
                            '<span class="icon">❌</span> Error';
                          alert("Failed to save: " + err.message);
                          setTimeout(() => {
                            saveBtn.innerHTML =
                              '<span class="icon">💾</span> Save Disclosure Data';
                            saveBtn.disabled = false;
                          }, 1200);
                        });
                    } catch (e) {
                      alert("Unexpected error: " + e.message);
                    }
                  };
                }
              }, 0);
              }

              const content = `
    ${managerHtml}
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Mandatory Public Disclosure</h2>
        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">Edit all CBSE-mandated disclosure data for your public page.</p>
      </div>
      <div class="card-content">
        ${dropdown}
        <div id="disclosure-section-content">${sectionHtml}</div>
        <div class="form-actions" style="margin-top:2rem;">
          <button class="btn btn-primary"><span class="icon">💾</span> Save Disclosure Data</button>
        </div>
      </div>
    </div>
  `;
              document.getElementById("content-area").innerHTML = content;
              // Dropdown change
              const sectionSelect = document.getElementById(
                "disclosure-section-select"
              );
              if (sectionSelect) {
                sectionSelect.addEventListener("change", function (e) {
                  window.disclosureSectionSelected = e.target.value;
                  renderDisclosureSection();
                });
              }
              // Enable/disable section
              document
                .querySelectorAll(".disclosure-section-enable")
                .forEach((cb) => {
                  cb.addEventListener("change", function (e) {
                    const idx = +e.target.getAttribute("data-section-idx");
                    disclosureSections[idx].enabled = e.target.checked;
                    renderDisclosureSection();
                  });
                });
              // Move up/down
              document.querySelectorAll("button[data-move]").forEach((btn) => {
                btn.addEventListener("click", function (e) {
                  const idx = +btn.getAttribute("data-section-idx");
                  const dir = btn.getAttribute("data-move");
                  if (dir === "up" && idx > 0) {
                    [disclosureSections[idx - 1], disclosureSections[idx]] = [
                      disclosureSections[idx],
                      disclosureSections[idx - 1],
                    ];
                  } else if (
                    dir === "down" &&
                    idx < disclosureSections.length - 1
                  ) {
                    [disclosureSections[idx + 1], disclosureSections[idx]] = [
                      disclosureSections[idx],
                      disclosureSections[idx + 1],
                    ];
                  }
                  renderDisclosureSection();
                });
              });
              // Delete custom section
              document
                .querySelectorAll("button[data-delete-section]")
                .forEach((btn) => {
                  btn.addEventListener("click", function (e) {
                    const idx = +btn.getAttribute("data-delete-section");
                    disclosureSections.splice(idx, 1);
                    // If the deleted section was selected, select a valid one
                    if (
                      window.disclosureSectionSelected &&
                      !disclosureSections.some(
                        (s) => s.id === window.disclosureSectionSelected
                      )
                    ) {
                      // Pick the first enabled section, or fallback to the first section
                      const enabled = disclosureSections.find((s) => s.enabled);
                      window.disclosureSectionSelected = enabled
                        ? enabled.id
                        : disclosureSections[0]?.id || null;
                    }
                    renderDisclosureSection();
                  });
                });
              // Add custom section
              const addCustomSectionBtn =
                document.getElementById("add-custom-section");
              if (addCustomSectionBtn) {
                addCustomSectionBtn.addEventListener("click", function () {
                  const label = prompt("Enter custom section title:");
                  if (label && label.trim()) {
                    // Generate a unique id for the custom section
                    let baseId = label
                      .trim()
                      .toLowerCase()
                      .replace(/[^a-z0-9]+/g, "_")
                      .replace(/^_+|_+$/g, "");
                    let id = baseId;
                    let i = 1;
                    while (window.disclosureSections.some((s) => s.id === id)) {
                      id = baseId + "_" + i;
                      i++;
                    }
                    // Add the new custom section
                    window.disclosureSections.push({
                      id: id,
                      label: label.trim(),
                      enabled: true,
                      standard: false,
                      fields: [{}], // Always start with a single blank field (no label, no type)
                    });
                    // Set as selected
                    window.disclosureSectionSelected = id;
                    renderDisclosureSection();
                  }
                });
              }
              // Add/remove/edit custom fields (only for custom sections)
              if (
                selected &&
                disclosureSections.find((s) => s.id === selected && !s.standard)
              ) {
                // Always show section selector and Add Section button
                const contentArea = document.getElementById("content-area");

                let sectionSelectorHtml = `
                  <div style="margin-bottom:2rem; display:flex; align-items:center; gap:1.5rem; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:1.1rem 1.5rem 1.1rem 1.5rem; box-shadow:0 1px 4px #f1f5f9;">
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                      <label for="disclosure-section-select" style="font-weight:500; color:#334155; font-size:1.05rem; margin-right:0.5rem;">Section:</label>
                      <select id="disclosure-section-select" style="font-size:1.05rem; padding:7px 16px; border-radius:7px; border:1px solid #cbd5e1; background:#fff; color:#1e293b; min-width:160px;">
                        ${disclosureSections.map(s => `<option value="${s.id}"${s.id===selected?' selected':''}>${s.label}</option>`).join('')}
                      </select>
                    </div>
                    <div style="height:32px; width:1px; background:#e5e7eb; margin:0 0.5rem;"></div>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                      <button id="move-section-up" class="btn btn-secondary btn-sm" style="padding:4px 10px;" title="Move section up (rearrange order)" ${disclosureSections.findIndex(s=>s.id===selected)===0?'disabled':''}>⬆️</button>
                      <button id="move-section-down" class="btn btn-secondary btn-sm" style="padding:4px 10px;" title="Move section down (rearrange order)" ${disclosureSections.findIndex(s=>s.id===selected)===disclosureSections.length-1?'disabled':''}>⬇️</button>
                      <button id="delete-section" class="btn btn-danger btn-sm" style="padding:4px 10px;" title="Delete this section">🗑️</button>
                    </div>
                    <div style="height:32px; width:1px; background:#e5e7eb; margin:0 0.5rem;"></div>
                    <button id="add-custom-section" class="btn btn-primary" style="font-size:1.05rem; padding:7px 20px; border-radius:7px;">
                      <span class="icon">➕</span> Add Section
                    </button>
                  </div>
                `;

                // Render table UI for the selected section
                const section = disclosureSections.find((s) => s.id === selected);
                if (!section || !contentArea) return;

                // Ensure fields array exists
                if (!Array.isArray(section.fields)) section.fields = [];
                // Ensure rows array exists
                if (!Array.isArray(section.rows)) section.rows = [];

                // Table header: fields (columns)
                let tableHeader = `<tr>`;
                section.fields.forEach((f, idx) => {
                  tableHeader += `<th style="background:#f8fafc; padding:8px; border-bottom:1px solid #e5e7eb;">
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                      <input type="text" value="${f.label || ''}" data-field-idx="${idx}" placeholder="Field name" class="form-input" style="width: 120px; font-size: 1rem;" />
                      <button data-remove-field="${idx}" title="Remove column" class="btn btn-danger btn-sm" style="padding:2px 8px;">🗑️</button>
                    </div>
                  </th>`;
                });
                tableHeader += `<th style="background:#f8fafc; padding:8px; border-bottom:1px solid #e5e7eb; text-align:center;">
                  <button id="add-custom-field" class="btn btn-secondary btn-sm" style="font-size:0.95rem;">+ Add Column</button>
                </th>`;
                tableHeader += `</tr>`;

                // Table body: rows (records)
                let tableBody = '';
                section.rows.forEach((row, rIdx) => {
                  tableBody += `<tr>`;
                  section.fields.forEach((f, cIdx) => {
                    tableBody += `<td style="padding:6px 8px; background:#fff; border-bottom:1px solid #f1f5f9;">
                      <input type="text" value="${row[cIdx] || ''}" data-row-idx="${rIdx}" data-col-idx="${cIdx}" class="form-input" style="width: 120px; font-size: 1rem;" />
                    </td>`;
                  });
                  tableBody += `<td style="text-align:center; background:#fff; border-bottom:1px solid #f1f5f9;">
                    <button data-remove-row="${rIdx}" title="Remove row" class="btn btn-danger btn-sm" style="padding:2px 8px;">🗑️</button>
                  </td>`;
                  tableBody += `</tr>`;
                });
                // Add row button
                tableBody += `<tr><td colspan="${section.fields.length + 1}" style="background:#f8fafc; text-align:left; padding:12px 8px;">
                  <button id="add-custom-row" class="btn btn-secondary btn-sm" style="font-size:0.95rem;">+ Add Row</button>
                </td></tr>`;

                // Render section selector and table
                contentArea.innerHTML = `
                  ${sectionSelectorHtml}
                  <div class="card" style="box-shadow:0 2px 8px #e5e7eb; border-radius:12px;">
                    <div class="card-header" style="border-bottom:1px solid #e5e7eb; background:#f8fafc; border-radius:12px 12px 0 0;">
                      <h2 class="card-title" style="margin:0; font-size:1.3rem; font-weight:600; color:#1e293b;">${section.label}</h2>
                    </div>
                    <div class="card-content" style="padding:2rem 1.5rem 1.5rem 1.5rem; background:#f9fafb; border-radius:0 0 12px 12px;">
                      <div style="overflow-x:auto;">
                        <table class="table" style="width:100%; border-collapse:separate; border-spacing:0; background:#fff; border-radius:8px; box-shadow:0 1px 2px #f1f5f9;">
                          <thead>${tableHeader}</thead>
                          <tbody>${tableBody}</tbody>
                        </table>
                      </div>
                      <div class="form-actions" style="margin-top:1.5rem; text-align:right;">
                        <button class="btn btn-primary" id="save-section-data" style="font-size:1.1rem; padding:10px 28px; border-radius:10px;">
                          <span class="icon">💾</span>
                          Save Section Data
                        </button>
                      </div>
                    </div>
                  </div>
                `;

                // Re-attach section selector and add section button events
                const sectionSelect = document.getElementById("disclosure-section-select");
                if (sectionSelect) {
                  sectionSelect.addEventListener("change", function (e) {
                    window.disclosureSectionSelected = e.target.value;
                    renderDisclosureSection();
                  });
                }
                const addCustomSectionBtn = document.getElementById("add-custom-section");
                if (addCustomSectionBtn) {
                  addCustomSectionBtn.addEventListener("click", function () {
                    const label = prompt("Enter custom section title:");
                    if (label && label.trim()) {
                      // Generate a unique id for the custom section
                      let baseId = label.trim().toLowerCase().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
                      let id = baseId;
                      let i = 1;
                      while (window.disclosureSections.some((s) => s.id === id)) {
                        id = baseId + "_" + i;
                        i++;
                      }
                      // Add the new custom section
                      window.disclosureSections.push({
                        id: id,
                        label: label.trim(),
                        enabled: true,
                        standard: false,
                        fields: [],
                        rows: [],
                      });
                      // Set as selected
                      window.disclosureSectionSelected = id;
                      renderDisclosureSection();
                    }
                  });
                }
                // Move section up
                const moveUpBtn = document.getElementById("move-section-up");
                if (moveUpBtn) {
                  moveUpBtn.addEventListener("click", function () {
                    const idx = disclosureSections.findIndex(s => s.id === selected);
                    if (idx > 0) {
                      [disclosureSections[idx - 1], disclosureSections[idx]] = [disclosureSections[idx], disclosureSections[idx - 1]];
                      renderDisclosureSection();
                    }
                  });
                }
                // Move section down
                const moveDownBtn = document.getElementById("move-section-down");
                if (moveDownBtn) {
                  moveDownBtn.addEventListener("click", function () {
                    const idx = disclosureSections.findIndex(s => s.id === selected);
                    if (idx < disclosureSections.length - 1) {
                      [disclosureSections[idx + 1], disclosureSections[idx]] = [disclosureSections[idx], disclosureSections[idx + 1]];
                      renderDisclosureSection();
                    }
                  });
                }
                // Delete section
                const deleteBtn = document.getElementById("delete-section");
                if (deleteBtn) {
                  deleteBtn.addEventListener("click", function () {
                    const idx = disclosureSections.findIndex(s => s.id === selected);
                    if (idx !== -1) {
                      disclosureSections.splice(idx, 1);
                      // Select next available section
                      if (disclosureSections.length > 0) {
                        window.disclosureSectionSelected = disclosureSections[Math.max(0, idx - 1)].id;
                      } else {
                        window.disclosureSectionSelected = null;
                      }
                      renderDisclosureSection();
                    }
                  });
                }

                // Add column (field)
                const addFieldBtn = document.getElementById("add-custom-field");
                if (addFieldBtn) {
                  addFieldBtn.addEventListener("click", function () {
                    section.fields.push({ label: "" });
                    // Add empty value to all existing rows
                    section.rows.forEach(row => row.push(""));
                    renderDisclosureSection();
                  });
                }
                // Remove column (field)
                document.querySelectorAll("button[data-remove-field]").forEach((btn) => {
                  btn.addEventListener("click", function () {
                    let idx = +btn.getAttribute("data-remove-field");
                    section.fields.splice(idx, 1);
                    // Remove value from all rows
                    section.rows.forEach(row => row.splice(idx, 1));
                    renderDisclosureSection();
                  });
                });
                // Edit field label
                document.querySelectorAll("input[data-field-idx]").forEach((el) => {
                  el.addEventListener("input", function () {
                    let idx = +el.getAttribute("data-field-idx");
                    section.fields[idx].label = el.value;
                  });
                });
                // Add row (record)
                const addRowBtn = document.getElementById("add-custom-row");
                if (addRowBtn) {
                  addRowBtn.addEventListener("click", function () {
                    // New row: array of empty strings, one per field
                    section.rows.push(Array(section.fields.length).fill(""));
                    renderDisclosureSection();
                  });
                }
                // Remove row
                document.querySelectorAll("button[data-remove-row]").forEach((btn) => {
                  btn.addEventListener("click", function () {
                    let idx = +btn.getAttribute("data-remove-row");
                    section.rows.splice(idx, 1);
                    renderDisclosureSection();
                  });
                });
                // Edit cell value
                document.querySelectorAll("input[data-row-idx][data-col-idx]").forEach((el) => {
                  el.addEventListener("input", function () {
                    let rIdx = +el.getAttribute("data-row-idx");
                    let cIdx = +el.getAttribute("data-col-idx");
                    section.rows[rIdx][cIdx] = el.value;
                  });
                });
                // Save section data
                const saveSectionBtn = document.getElementById("save-section-data");
                if (saveSectionBtn) {
                  saveSectionBtn.addEventListener("click", function () {
                    // Save logic: call saveData for this section
                    if (typeof saveData === 'function') {
                      saveData(section.id, { fields: section.fields, rows: section.rows });
                      if (typeof showSuccessIndicator === 'function') {
                        showSuccessIndicator('section-save', 'Section data saved successfully');
                      }
                    } else {
                      alert('Save function not available.');
                    }
                  });
                }
              }
            }
        }
      }

      // Faculty section renderer
      function renderFacultySection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Faculty Members</h2>
            <button class="btn btn-primary" onclick="addRow('faculty')">
              <span class="icon"></span>
              Add Faculty Member
            </button>
          </div>
          <div class="alert alert-info" style="margin: 20px; background: #e8f4fd; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px;">
            <strong>📸 Firebase Optimized:</strong> Faculty photos are automatically compressed to under 700KB for optimal Firebase performance. 
            The system maintains image quality while ensuring fast loading times.
          </div>
          <div class="card-content">
            <div class="table-container" id="faculty-table"></div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
        renderTable("faculty");
      }

      // Gallery section renderer
      function renderGallerySection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Gallery Images</h2>
            <button class="btn btn-primary" onclick="addRow('gallery')">
              <span class="icon"></span>
              Add Gallery Image
            </button>
          </div>
          <div class="alert alert-info" style="margin: 20px; background: #e8f4fd; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px;">
            <strong>🖼️ Firebase Optimized:</strong> Images are automatically compressed to under 700KB for Firebase compatibility. 
            You'll see a notification during processing. Supported formats: JPG, PNG, WebP.
          </div>
          <div class="card-content">
            <div class="table-container" id="gallery-table"></div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
        renderTable("gallery");
      }

      // Testimonials section renderer
      function renderTestimonialsSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Testimonials</h2>
            <button class="btn btn-primary" onclick="addRow('testimonials')">
              <span class="icon"></span>
              Add Testimonial
            </button>
          </div>
          <div class="card-content">
            <div class="table-container" id="testimonials-table"></div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
        renderTable("testimonials");
      }

      // Events section renderer
      function renderEventsSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Notice Board Management</h2>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
              Manage notices, announcements, and events displayed on the school notice board
            </p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
              <button class="btn btn-primary" onclick="addRow('events')">
                <span class="icon"></span>
                Add New Notice
              </button>
              <button class="btn btn-secondary" onclick="exportNotices()">
                <span class="icon">📥</span>
                Export Notices
              </button>
              <button class="btn btn-secondary" onclick="document.getElementById('import-notices').click()">
                <span class="icon">📤</span>
                Import Notices
              </button>
              <input type="file" id="import-notices" accept=".json" style="display: none;" onchange="importNotices(event)">
            </div>
          </div>
          <div class="card-content">
            <div class="notice-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
              <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold;">${
                  eventsData.filter((n) => n.category === "urgent").length
                }</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Urgent Notices</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold;">${
                  eventsData.filter((n) => n.category === "academic").length
                }</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Academic Notices</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold;">${
                  eventsData.filter((n) => n.category === "events").length
                }</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Event Notices</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold;">${
                  eventsData.filter((n) => n.category === "general").length
                }</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">General Notices</div>
              </div>
            </div>
            <div class="table-container" id="events-table"></div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
        renderTable("events");
      }

      // Academics section renderer
      function renderAcademicsSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Academics Information</h2>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label class="form-label">Section Description</label>
              <textarea class="form-input" rows="3" id="academics-description" 
                        placeholder="Brief description about the academic program">${
                          academicsData.description || ""
                        }</textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">Curriculum</label>
              <input type="text" class="form-input" id="academics-curriculum" 
                     value="${academicsData.curriculum || ""}" 
                     placeholder="e.g., CBSE syllabus from Nursery to Class XII">
            </div>
            
            <div class="form-group">
              <label class="form-label">Special Programs</label>
              <input type="text" class="form-input" id="academics-programs" 
                     value="${academicsData.programs || ""}" 
                     placeholder="e.g., STEM initiatives, Coding clubs, Language enrichment">
            </div>
            
            <div class="form-group">
              <label class="form-label">Assessment Methods</label>
              <input type="text" class="form-input" id="academics-assessment" 
                     value="${academicsData.assessment || ""}" 
                     placeholder="e.g., Continuous Evaluation, Project Based Learning, Olympiads preparation">
            </div>
            
            <div class="form-group">
              <label class="form-label">Extra-Curricular Activities</label>
              <input type="text" class="form-input" id="academics-extracurricular" 
                     value="${academicsData.extracurricular || ""}" 
                     placeholder="e.g., Art, Music, Dance, Debate, and Sports">
            </div>
            
            <div class="form-actions">
              <button class="btn btn-primary" onclick="saveAcademicsData()">
                <span class="icon">💾</span>
                Save Academics Information
              </button>
            </div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // FAQ section renderer
      function renderFaqSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">FAQ Management</h2>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
              Manage frequently asked questions displayed on your website
            </p>
          </div>
          <div class="card-content">
            <div class="form-actions" style="margin-bottom: 2rem;">
              <button class="btn btn-primary" onclick="addNewFaq()">
                <span class="icon"></span>
                Add New FAQ
              </button>
            </div>
            
            <div class="faq-list">
              ${faqData
                .map(
                  (faq, index) => `
                <div class="faq-item" data-index="${index}">
                  <div class="faq-header">
                    <h4>FAQ ${index + 1}</h4>
                    <div class="faq-actions">
                      <button class="btn btn-secondary btn-sm" onclick="moveFaq(${index}, 'up')" ${
                    index === 0 ? "disabled" : ""
                  }>
                        <span class="icon">⬆️</span>
                      </button>
                      <button class="btn btn-secondary btn-sm" onclick="moveFaq(${index}, 'down')" ${
                    index === faqData.length - 1 ? "disabled" : ""
                  }>
                        <span class="icon">⬇️</span>
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="deleteFaq(${index})">
                        <span class="icon">🗑️</span>
                      </button>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Question</label>
                    <input type="text" class="form-input" 
                           value="${faq.question.replace(/"/g, "&quot;")}" 
                           onchange="updateFaqData(${index}, 'question', this.value)"
                           placeholder="Enter the question">
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Answer</label>
                    <textarea class="form-input" rows="3" 
                              onchange="updateFaqData(${index}, 'answer', this.value)"
                              placeholder="Enter the answer">${
                                faq.answer
                              }</textarea>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
            
            <div class="form-actions" style="margin-top: 2rem;">
              <button class="btn btn-primary" onclick="saveFaqData()">
                <span class="icon">💾</span>
                Save All FAQ Changes
              </button>
            </div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // Hero section renderer
      function renderHeroSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Homepage Hero Section</h2>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label class="form-label">Main Title</label>
              <input type="text" class="form-input" value="${heroData.title.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateHeroData('title', this.value)" placeholder="School Name">
            </div>
            <div class="form-group">
              <label class="form-label">Subtitle</label>
              <input type="text" class="form-input" value="${heroData.subtitle.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateHeroData('subtitle', this.value)" placeholder="Tagline">
            </div>
            <div class="form-group">
              <label class="form-label">Background Image</label>
              <div class="alert alert-info" style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 14px;">
                <strong>🎨 Firebase Optimized:</strong> Images are automatically compressed to under 700KB for Firebase compatibility while maintaining quality.
              </div>
              <div class="image-upload-area" onclick="document.getElementById('hero-bg-upload').click()">
                ${
                  heroData.backgroundImage
                    ? `<img src="${heroData.backgroundImage}" class="image-preview" />`
                    : ""
                }
                <p>Click to upload background image</p>
                <input type="file" id="hero-bg-upload" style="display: none;" accept="image/*" 
                       onchange="uploadHeroBackground(this)">
              </div>
            </div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // About section renderer
      function renderAboutSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">About Section</h2>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label class="form-label">About Content</label>
              <textarea class="form-input form-textarea" onchange="updateAboutData('content', this.value)" 
                        placeholder="Write about the school..." rows="4">${aboutData.content.replace(
                          /"/g,
                          "&quot;"
                        )}</textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Leadership Team</h2>
          </div>
          <div class="card-content">
            ${aboutData.leadership
              .map(
                (leader, index) => `
              <div class="leadership-item" style="border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">${
                  leader.position
                }</h3>
                
                <div class="form-group">
                  <label class="form-label">Name</label>
                  <input type="text" class="form-input" value="${leader.name.replace(
                    /"/g,
                    "&quot;"
                  )}" 
                         onchange="updateLeadershipData(${index}, 'name', this.value)" placeholder="Full Name">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Position</label>
                  <input type="text" class="form-input" value="${leader.position.replace(
                    /"/g,
                    "&quot;"
                  )}" 
                         onchange="updateLeadershipData(${index}, 'position', this.value)" placeholder="Position/Title">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea class="form-input form-textarea" onchange="updateLeadershipData(${index}, 'description', this.value)" 
                            placeholder="Brief description..." rows="2">${leader.description.replace(
                              /"/g,
                              "&quot;"
                            )}</textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Profile Image</label>
                  <div class="image-upload-section" style="border: 1px solid var(--border); padding: 1rem; border-radius: 8px; background: #f8fafc;">
                    ${
                      leader.image
                        ? `
                      <div class="current-image" style="margin-bottom: 1rem;">
                        <img src="${leader.image}" alt="Current ${leader.position} photo" 
                             style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);">
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">Current Image</p>
                      </div>
                    `
                        : ""
                    }
                    
                    <div class="upload-options">
                      <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label" style="font-size: 0.875rem;">Upload New Image</label>
                        <input type="file" class="form-input" accept="image/*" 
                               onchange="handleImageUpload(this, ${index}, 'leadership')" 
                               style="font-size: 0.875rem;">
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Supported: JPG, PNG, GIF (Max 5MB)</small>
                      </div>
                      
                      <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.875rem;">Or Enter Image Path</label>
                        <input type="text" class="form-input" value="${leader.image.replace(
                          /"/g,
                          "&quot;"
                        )}" 
                               onchange="updateLeadershipData(${index}, 'image', this.value)" 
                               placeholder="assets/image.jpg" style="font-size: 0.875rem;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">School Highlights</h2>
          </div>
          <div class="card-content">
            ${aboutData.highlights
              .map(
                (highlight, index) => `
              <div class="highlight-item" style="border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">${
                  highlight.title
                }</h3>
                
                <div class="form-group">
                  <label class="form-label">Icon (Emoji)</label>
                  <input type="text" class="form-input" value="${
                    highlight.icon
                  }" 
                         onchange="updateHighlightData(${index}, 'icon', this.value)" placeholder="🏛️" maxlength="2">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Title</label>
                  <input type="text" class="form-input" value="${highlight.title.replace(
                    /"/g,
                    "&quot;"
                  )}" 
                         onchange="updateHighlightData(${index}, 'title', this.value)" placeholder="Highlight Title">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea class="form-input form-textarea" onchange="updateHighlightData(${index}, 'description', this.value)" 
                            placeholder="Brief description..." rows="2">${highlight.description.replace(
                              /"/g,
                              "&quot;"
                            )}</textarea>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // Logo section renderer
      function renderLogoSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">School Logo Management</h2>
          </div>
          <div class="card-content">
            <div class="alert alert-info" style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <strong>🎨 Logo Guidelines:</strong> For best results, use a square logo (1:1 ratio) in PNG format. 
              The logo will be automatically resized to fit the header design. Recommended size: 200x200px or larger.
            </div>
            
            <div class="form-group">
              <label class="form-label">Current Logo</label>
              <div class="current-logo" style="margin-bottom: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface-elevated);">
                <img src="${
                  logoData.logoUrl || "assets/logo.png"
                }" alt="Current School Logo" 
                     style="width: 80px; height: 80px; object-fit: contain; border: 2px solid var(--primary-color); border-radius: 8px;">
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">Current Logo</p>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Upload New Logo</label>
              <div class="alert alert-info" style="background: #e8f4fd; border: 1px solid #bee5eb; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 14px;">
                <strong>📸 Firebase Optimized:</strong> Images are automatically compressed to under 700KB for Firebase compatibility while maintaining quality.
              </div>
              <input type="file" class="form-input" accept="image/*" id="logo-upload" 
                     onchange="handleLogoUpload(this)" style="margin-bottom: 10px;">
              <small style="color: var(--text-secondary); font-size: 0.75rem;">Supported: JPG, PNG, GIF (Max 5MB) | Best format: PNG with transparent background</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Or Enter Logo URL</label>
              <input type="text" class="form-input" id="logo-url" 
                     value="${(logoData.logoUrl || "").replace(
                       /"/g,
                       "&quot;"
                     )}" 
                     placeholder="Enter logo image URL" onchange="updateLogoData('logoUrl', this.value)">
            </div>
            
            <div class="form-group">
              <label class="form-label">School Name</label>
              <input type="text" class="form-input" id="school-name" 
                     value="${(logoData.schoolName || "").replace(
                       /"/g,
                       "&quot;"
                     )}" 
                     placeholder="School Name" onchange="updateLogoData('schoolName', this.value)">
            </div>
            
            <div class="form-group">
              <label class="form-label">School Tagline</label>
              <input type="text" class="form-input" id="school-tagline" 
                     value="${(logoData.tagline || "").replace(
                       /"/g,
                       "&quot;"
                     )}" 
                     placeholder="School Tagline" onchange="updateLogoData('tagline', this.value)">
            </div>
            
            <div class="form-actions">
              <button class="btn btn-primary" onclick="saveLogoData()">
                <span class="icon">💾</span>
                Save Logo Changes
              </button>
            </div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // School info section renderer
      function renderSchoolInfoSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">School Information</h2>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label class="form-label">School Name</label>
              <input type="text" class="form-input" value="${schoolInfoData.name.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateSchoolInfo('name', this.value)" placeholder="School Name">
            </div>
            <div class="form-group">
              <label class="form-label">Address</label>
              <textarea class="form-input form-textarea" onchange="updateSchoolInfo('address', this.value)" 
                        placeholder="School address...">${schoolInfoData.address.replace(
                          /"/g,
                          "&quot;"
                        )}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Phone Number</label>
              <input type="text" class="form-input" value="${schoolInfoData.phone.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateSchoolInfo('phone', this.value)" placeholder="Phone number">
            </div>
            <div class="form-group">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-input" value="${schoolInfoData.email.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateSchoolInfo('email', this.value)" placeholder="Email address">
            </div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // Contact section renderer
      function renderContactSection() {
        const content = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Contact Details</h2>
          </div>
          <div class="card-content">
            <div class="form-group">
              <label class="form-label">Contact Address</label>
              <textarea class="form-input form-textarea" onchange="updateContactData('address', this.value)" 
                        placeholder="Contact address...">${contactData.address.replace(
                          /"/g,
                          "&quot;"
                        )}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Contact Phone</label>
              <input type="text" class="form-input" value="${contactData.phone.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateContactData('phone', this.value)" placeholder="Contact phone">
            </div>
            <div class="form-group">
              <label class="form-label">Contact Email</label>
              <input type="email" class="form-input" value="${contactData.email.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateContactData('email', this.value)" placeholder="Contact email">
            </div>
            <div class="form-group">
              <label class="form-label">Office Hours</label>
              <input type="text" class="form-input" value="${contactData.hours.replace(
                /"/g,
                "&quot;"
              )}" 
                     onchange="updateContactData('hours', this.value)" placeholder="Office hours">
            </div>
          </div>
        </div>
      `;
        document.getElementById("content-area").innerHTML = content;
      }

      // Sample data for local mode
      const sampleData = {
        faculty: [
          {
            id: "1",
            name: "Ms. Priya Sharma",
            role: "Head of Science Department",
            description:
              "15 years of teaching experience and passion for student mentoring.",
            photo: "assets/faculty1.jpg",
          },
          {
            id: "2",
            name: "Mr. Arjun Singh",
            role: "Mathematics Teacher",
            description:
              "Expert in advanced problem solving and Olympiad training.",
            photo: "assets/faculty2.jpg",
          },
          {
            id: "3",
            name: "Mrs. Neha Verma",
            role: "English Literature",
            description:
              "Creative curriculum developer and drama club advisor.",
            photo: "assets/faculty3.jpg",
          },
        ],
        gallery: [
          {
            id: "1",
            src: "assets/gallery7.jpg",
            alt: "Science experiments in the school lab",
          },
          {
            id: "2",
            src: "assets/gallery8.jpg",
            alt: "School activity or event",
          },
          { id: "3", src: "assets/gallery9.jpg", alt: "Students in classroom" },
        ],
        testimonials: [
          {
            id: "1",
            name: "Ravi Kumar",
            role: "Parent",
            text: "Vikas Public School has transformed my child's life with excellent academics and a nurturing environment.",
          },
          {
            id: "2",
            name: "Meera Singh",
            role: "Student",
            text: "The teachers here are supportive and the activities are fun and enriching. I love being part of the school.",
          },
        ],
        events: [
          {
            id: "1",
            title: "Mid-term Examination Schedule Released",
            date: "2025-07-27",
            validUntil: "2025-09-30",
            category: "urgent",
            description:
              "Mid-term examinations for all classes will commence from September 15, 2025. Students must prepare according to the detailed schedule available in the admissions section.",
          },
          {
            id: "2",
            title: "Annual Sports Day - August 15, 2025",
            date: "2025-07-25",
            validUntil: "",
            category: "events",
            description:
              "Join us for a day full of sportsmanship and fun activities for all students. Participation forms available at the sports department.",
          },
          {
            id: "3",
            title: "Science Exhibition - September 10, 2025",
            date: "2025-07-20",
            validUntil: "",
            category: "academic",
            description:
              "A platform for young innovators to showcase their projects and experiments. Registration deadline: August 25, 2025.",
          },
          {
            id: "4",
            title: "Parent-Teacher Meeting - October 5, 2025",
            date: "2025-07-18",
            validUntil: "",
            category: "general",
            description:
              "Discuss your child's progress and participate in school development feedback sessions. Meeting timings: 9 AM to 4 PM.",
          },
          {
            id: "5",
            title: "Holiday Notice - Independence Day",
            date: "2025-07-27",
            validUntil: "2025-08-15",
            category: "urgent",
            description:
              "School will remain closed on August 15, 2025, in observance of Independence Day. Regular classes will resume on August 16, 2025.",
          },
        ],
        about: {
          content:
            "Vikas Public School, established in 2004, is committed to nurturing young minds through holistic education. Our mission is to foster intellectual curiosity, critical thinking, and responsible citizenship through a dynamic curriculum and dedicated faculty.",
          leadership: [
            {
              id: "manager",
              name: "Jatashankar Pal",
              position: "Manager",
              description:
                "Leading the institution with vision and dedication to excellence in education.",
              image: "assets/IMG-20250726-WA0016.jpg",
            },
            {
              id: "principal",
              name: "Principal",
              position: "Principal",
              description:
                "Committed to fostering academic excellence and character development.",
              image: "assets/IMG-20250726-WA0017.jpg",
            },
          ],
          highlights: [
            {
              id: "cbse",
              icon: "🏛️",
              title: "CBSE Affiliation",
              description: "Accredited standards ensuring quality education",
            },
            {
              id: "campus",
              icon: "🏫",
              title: "Modern Campus",
              description:
                "Smart classrooms, libraries, science labs, and sports facilities",
            },
            {
              id: "development",
              icon: "🎯",
              title: "Holistic Development",
              description:
                "Focus on academics, co-curricular activities, and personal growth",
            },
            {
              id: "environment",
              icon: "🛡️",
              title: "Safe Environment",
              description:
                "Inclusive and secure learning atmosphere for all students",
            },
          ],
        },
      };

      // Update functions for new sections
      function updateHeroData(field, value) {
        heroData[field] = value;
        saveData("hero", heroData);
        showSuccessIndicator("hero-update", `Hero ${field} updated`);
      }

      function updateAboutData(field, value) {
        aboutData[field] = value;
        saveData("about", aboutData);
        showSuccessIndicator("about-update", `About ${field} updated`);
      }

      function saveAcademicsData() {
        academicsData.description = document.getElementById(
          "academics-description"
        ).value;
        academicsData.curriculum = document.getElementById(
          "academics-curriculum"
        ).value;
        academicsData.programs =
          document.getElementById("academics-programs").value;
        academicsData.assessment = document.getElementById(
          "academics-assessment"
        ).value;
        academicsData.extracurricular = document.getElementById(
          "academics-extracurricular"
        ).value;

        saveData("academics", academicsData);
        showSuccessIndicator(
          "academics-save",
          "Academics information updated successfully"
        );
      }

      // FAQ Management Functions
      function addNewFaq() {
        const newFaq = {
          id: "faq" + (faqData.length + 1),
          question: "New Question",
          answer: "New Answer",
        };
        faqData.push(newFaq);
        renderFaqSection();
        showSuccessIndicator("faq-add", "New FAQ added");
      }

      function deleteFaq(index) {
        if (confirm("Are you sure you want to delete this FAQ?")) {
          faqData.splice(index, 1);
          renderFaqSection();
          showSuccessIndicator("faq-delete", "FAQ deleted successfully");
        }
      }

      function moveFaq(index, direction) {
        if (direction === "up" && index > 0) {
          [faqData[index], faqData[index - 1]] = [
            faqData[index - 1],
            faqData[index],
          ];
        } else if (direction === "down" && index < faqData.length - 1) {
          [faqData[index], faqData[index + 1]] = [
            faqData[index + 1],
            faqData[index],
          ];
        }
        renderFaqSection();
        showSuccessIndicator("faq-move", "FAQ order updated");
      }

      function updateFaqData(index, field, value) {
        faqData[index][field] = value;
        showSuccessIndicator("faq-update", `FAQ ${field} updated`);
      }

      function saveFaqData() {
        // Update FAQ IDs to maintain consistency
        faqData.forEach((faq, index) => {
          faq.id = "faq" + (index + 1);
        });

        if (BYPASS_AUTH) {
          console.log("FAQ data saved in local mode");
          showSuccessIndicator("faq-save", "All FAQ changes saved locally");
          return;
        }

        // Clear existing FAQ collection and re-add all items
        const batch = db.batch();

        // First, get all existing FAQ documents to delete them
        db.collection("faq")
          .get()
          .then((snapshot) => {
            // Delete existing documents
            snapshot.docs.forEach((doc) => {
              batch.delete(doc.ref);
            });

            // Add new FAQ data
            faqData.forEach((faq) => {
              const docRef = db.collection("faq").doc();
              batch.set(docRef, faq);
            });

            // Commit the batch
            batch
              .commit()
              .then(() => {
                invalidateCache("faq");
                showSuccessIndicator(
                  "faq-save",
                  "All FAQ changes saved to Firebase successfully"
                );
              })
              .catch((err) => {
                console.error("Failed to save FAQ data:", err);
                alert("Failed to save FAQ data: " + err.message);
              });
          })
          .catch((err) => {
            console.error("Failed to fetch existing FAQ data:", err);
            alert("Failed to fetch existing FAQ data: " + err.message);
          });
      }

      function updateLogoData(field, value) {
        logoData[field] = value;
        saveData("logo", logoData);
        showSuccessIndicator("logo-update", `Logo ${field} updated`);

        // Update the main website immediately if it's the logo URL
        if (field === "logoUrl") {
          updateMainLogo();
        }
      }

      function saveLogoData() {
        logoData.logoUrl = document.getElementById("logo-url").value;
        logoData.schoolName = document.getElementById("school-name").value;
        logoData.tagline = document.getElementById("school-tagline").value;

        saveData("logo", logoData);
        showSuccessIndicator(
          "logo-save",
          "Logo information updated successfully"
        );
        updateMainLogo();
      }

      async function handleLogoUpload(input) {
        console.log("handleLogoUpload called:", input.files);

        if (input.files && input.files[0]) {
          const file = input.files[0];
          console.log("File selected:", file.name, file.size, file.type);

          // Validate file size (5MB limit)
          if (file.size > 5 * 1024 * 1024) {
            alert("File size too large. Please choose a file under 5MB.");
            return;
          }

          // Validate file type
          if (!file.type.startsWith("image/")) {
            alert("Please select a valid image file.");
            return;
          }

          try {
            showSuccessIndicator("logo-upload", "Uploading logo...");
            console.log("Starting compression process...");

            // Compress and convert to base64 using the existing function
            compressImageIfNeeded(file, function (compressedFile) {
              console.log("Compression callback called:", compressedFile);

              try {
                if (!compressedFile) {
                  throw new Error("Image compression failed");
                }

                console.log("Converting compressed file to data URL...");

                // Convert compressed file to data URL
                const reader = new FileReader();
                reader.onload = function (e) {
                  try {
                    const compressedDataUrl = e.target.result;
                    console.log(
                      "Data URL created, length:",
                      compressedDataUrl?.length
                    );

                    // Update logo data
                    logoData.logoUrl = compressedDataUrl;
                    const logoUrlInput = document.getElementById("logo-url");
                    if (logoUrlInput) {
                      logoUrlInput.value = compressedDataUrl;
                    }

                    console.log("Saving logo data to Firebase...");

                    // Save to database
                    saveData("logo", logoData);
                    showSuccessIndicator(
                      "logo-upload",
                      "Logo uploaded successfully!"
                    );

                    // Update the logo display and main website
                    updateMainLogo();
                    renderLogoSection(); // Re-render to show new logo
                  } catch (error) {
                    console.error(
                      "Error converting compressed logo to data URL:",
                      error
                    );
                    showSuccessIndicator(
                      "logo-upload",
                      "Error processing logo. Please try again."
                    );
                  }
                };

                reader.onerror = function (error) {
                  console.error("Error reading compressed file:", error);
                  showSuccessIndicator(
                    "logo-upload",
                    "Error reading compressed logo. Please try again."
                  );
                };

                reader.readAsDataURL(compressedFile);
              } catch (error) {
                console.error("Error processing compressed logo:", error);
                showSuccessIndicator(
                  "logo-upload",
                  "Error processing logo. Please try again."
                );
              }
            });
          } catch (error) {
            console.error("Error uploading logo:", error);
            showSuccessIndicator(
              "logo-upload",
              "Error uploading logo. Please try again."
            );
          }
        } else {
          console.log("No file selected");
        }
      }

      function updateMainLogo() {
        // This function can be used to update the logo on the main website
        // For now, it just logs the action since cross-frame communication would be needed
        console.log("Logo updated:", logoData);
      }

      function updateLeadershipData(index, field, value) {
        aboutData.leadership[index][field] = value;
        saveData("about", aboutData);
        showSuccessIndicator(
          "leadership-update",
          `Leadership ${field} updated`
        );
      }

      function updateHighlightData(index, field, value) {
        aboutData.highlights[index][field] = value;
        saveData("about", aboutData);
        showSuccessIndicator("highlight-update", `Highlight ${field} updated`);
      }

      // Handle image upload for leadership profiles
      function handleImageUpload(input, index, type) {
        const file = input.files[0];
        if (!file) return;

        // Validate file type
        const allowedTypes = [
          "image/jpeg",
          "image/jpg",
          "image/png",
          "image/gif",
        ];
        if (!allowedTypes.includes(file.type)) {
          alert("Please select a valid image file (JPG, PNG, or GIF)");
          input.value = "";
          return;
        }

        // Validate file size (5MB max)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
          alert("File size must be less than 5MB");
          input.value = "";
          return;
        }

        // Show upload progress
        const uploadIndicator = document.createElement("div");
        uploadIndicator.innerHTML =
          '<small style="color: var(--primary-color);">Uploading image...</small>';
        input.parentNode.appendChild(uploadIndicator);

        // Create a FileReader to convert image to base64
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // Create a unique filename
            const timestamp = new Date().getTime();
            const extension = file.name.split(".").pop();
            const filename = `${type}_${index}_${timestamp}.${extension}`;
            const imagePath = `assets/${filename}`;

            // For demo purposes, we'll use the base64 data URL
            // In a real implementation, you would upload to a server or Firebase Storage
            const imageData = e.target.result;

            // Update the leadership data with the new image path
            if (type === "leadership") {
              aboutData.leadership[index].image = imageData; // Using base64 for demo
              saveData("about", aboutData);
              showSuccessIndicator(
                "image-upload",
                `${aboutData.leadership[index].position} image uploaded`
              );

              // Re-render the about section to show the new image
              renderAboutSection();
            }

            // Remove upload indicator
            uploadIndicator.remove();
          } catch (error) {
            console.error("Error processing image:", error);
            alert("Error processing image. Please try again.");
            uploadIndicator.remove();
          }
        };

        reader.onerror = function () {
          alert("Error reading file. Please try again.");
          uploadIndicator.remove();
        };

        reader.readAsDataURL(file);
      }

      function updateSchoolInfo(field, value) {
        schoolInfoData[field] = value;
        saveData("school-info", schoolInfoData);
        showSuccessIndicator("school-info-update", `School ${field} updated`);
      }

      function updateContactData(field, value) {
        contactData[field] = value;
        saveData("contact", contactData);
        showSuccessIndicator("contact-update", `Contact ${field} updated`);
      }

      function uploadHeroBackground(input) {
        const file = input.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          alert("Please upload an image file.");
          return;
        }

        // Compress image if needed before processing
        compressImageIfNeeded(file, (compressedFile) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            heroData.backgroundImage = e.target.result;
            saveData("hero", heroData);

            const compressionMsg =
              compressedFile !== file ? " (compressed)" : "";
            showSuccessIndicator(
              "hero-bg-upload",
              `Background image uploaded${compressionMsg}`
            );
            renderHeroSection(); // Re-render to show new image
          };
          reader.readAsDataURL(compressedFile);
        });
      }

      // Generic save data function with size validation
      function saveData(collection, data) {
        if (BYPASS_AUTH) {
          console.log(`Saved ${collection} data in local mode`);
          return;
        }

        // Validate document size for Firebase Firestore limits
        const dataString = JSON.stringify(data);
        const dataSize = new Blob([dataString]).size;
        const dataSizeKB = (dataSize / 1024).toFixed(0);

        console.log(`Saving ${collection} data: ${dataSizeKB}KB`);

        // Firebase Firestore has a 1MB document limit
        if (dataSize > 1048576) {
          // 1MB in bytes
          const sizeMB = (dataSize / (1024 * 1024)).toFixed(1);
          console.error(`Document too large for Firebase: ${sizeMB}MB`);
          alert(
            `Failed to save ${collection} data: Document size (${sizeMB}MB) exceeds Firebase limit (1MB).\n\nTip: Try uploading a smaller image or the compression system will optimize it further.`
          );
          return;
        }

        // For non-array data, save as a single document
        if (
          collection === "hero" ||
          collection === "about" ||
          collection === "logo" ||
          collection === "academics" ||
          collection === "school-info" ||
          collection === "contact"
        ) {
          db.collection("settings")
            .doc(collection)
            .set(data)
            .then(() => {
              // Invalidate cache by updating timestamp
              invalidateCache(collection);
              console.log(
                `${collection} data saved to Firebase (${dataSizeKB}KB)`
              );
              showSuccessIndicator(
                `${collection}-save`,
                `${collection} data saved successfully`
              );
            })
            .catch((err) => {
              console.error(`Failed to save ${collection} data:`, err);
              if (
                err.code === "invalid-argument" &&
                err.message.includes("bytes")
              ) {
                alert(
                  `Image too large for Firebase storage. Please try uploading a smaller image.\n\nTechnical details: ${err.message}`
                );
              } else {
                alert(`Failed to save ${collection} data: ${err.message}`);
              }
            });
        }
      }

      // Cache invalidation function
      function invalidateCache(type) {
        if (BYPASS_AUTH) return;

        const timestamp = Date.now();
        const cacheInfo = {
          lastUpdated: timestamp,
          collection: type,
        };

        // Save cache invalidation timestamp to Firestore
        db.collection("cache")
          .doc(type)
          .set(cacheInfo)
          .then(() => {
            console.log(
              `Cache invalidated for ${type} at ${new Date(
                timestamp
              ).toISOString()}`
            );
          })
          .catch((err) => {
            console.warn(`Failed to invalidate cache for ${type}:`, err);
          });
      }

      // Load all data
      function loadAllData() {
        if (BYPASS_AUTH) {
          // Load sample data in local mode
          facultyData.length = 0;
          galleryData.length = 0;
          testimonialsData.length = 0;
          eventsData.length = 0;

          facultyData.push(...sampleData.faculty);
          galleryData.push(...sampleData.gallery);
          testimonialsData.push(...sampleData.testimonials);
          eventsData.push(...sampleData.events);

          // Load sample about data
          aboutData = { ...sampleData.about };

          // Only render table for current section to avoid null innerHTML errors
          if (currentSection === "faculty") renderTable("faculty");
          if (currentSection === "gallery") renderTable("gallery");
          if (currentSection === "testimonials") renderTable("testimonials");
          if (currentSection === "events") renderTable("events");
          console.log("Loaded sample data in local mode");
        } else {
          loadCollection("faculty", facultyData, renderTable);
          loadCollection("gallery", galleryData, renderTable);
          loadCollection("testimonials", testimonialsData, renderTable);
          loadCollection("events", eventsData, renderTable);

          // Load settings data for non-table sections
          loadSettingsData();
        }
      }

      // Initialize sample data in Firebase if collections are empty
      function initializeSampleData() {
        console.log("Checking if sample data needs to be initialized...");

        // Check if faculty collection is empty
        db.collection("faculty")
          .get()
          .then((snapshot) => {
            if (snapshot.empty) {
              console.log("Faculty collection is empty, adding sample data...");
              sampleData.faculty.forEach((item) => {
                const data = { ...item };
                delete data.id; // Remove id field before adding to Firestore
                db.collection("faculty").add(data);
              });
            }
          });

        // Check if gallery collection is empty
        db.collection("gallery")
          .get()
          .then((snapshot) => {
            if (snapshot.empty) {
              console.log("Gallery collection is empty, adding sample data...");
              sampleData.gallery.forEach((item) => {
                const data = { ...item };
                delete data.id;
                db.collection("gallery").add(data);
              });
            }
          });

        // Check if testimonials collection is empty
        db.collection("testimonials")
          .get()
          .then((snapshot) => {
            if (snapshot.empty) {
              console.log(
                "Testimonials collection is empty, adding sample data..."
              );
              sampleData.testimonials.forEach((item) => {
                const data = { ...item };
                delete data.id;
                db.collection("testimonials").add(data);
              });
            }
          });

        // Check if events collection is empty
        db.collection("events")
          .get()
          .then((snapshot) => {
            if (snapshot.empty) {
              console.log("Events collection is empty, adding sample data...");
              sampleData.events.forEach((item) => {
                const data = { ...item };
                delete data.id;
                db.collection("events").add(data);
              });
            }
          });

        // Check if about settings document exists
        db.collection("settings")
          .doc("about")
          .get()
          .then((doc) => {
            if (!doc.exists) {
              console.log("About settings not found, creating default...");
              db.collection("settings").doc("about").set(sampleData.about);
            }
          });
      }

      // Load settings data (hero, about, school-info, contact)
      function loadSettingsData() {
        if (BYPASS_AUTH) {
          console.log("Settings data loaded in local mode");
          return;
        }

        // Load hero data
        db.collection("settings")
          .doc("hero")
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              heroData.title = data.title || heroData.title;
              heroData.subtitle = data.subtitle || heroData.subtitle;
              heroData.backgroundImage =
                data.backgroundImage || heroData.backgroundImage;
              console.log("Hero data loaded:", heroData);

              // Re-render hero section if it's currently active
              if (currentSection === "hero") {
                renderHeroSection();
              }
            }
          })
          .catch((err) => {
            console.error("Error loading hero data:", err);
          });

        // Load about data
        db.collection("settings")
          .doc("about")
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              aboutData.content = data.content || aboutData.content;
              aboutData.mission = data.mission || aboutData.mission;
              aboutData.vision = data.vision || aboutData.vision;
              console.log("About data loaded:", aboutData);

              // Re-render about section if it's currently active
              if (currentSection === "about") {
                renderAboutSection();
              }
            }
          })
          .catch((err) => {
            console.error("Error loading about data:", err);
          });

        // Load school info data
        db.collection("settings")
          .doc("school-info")
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              schoolInfoData.name = data.name || schoolInfoData.name;
              schoolInfoData.address = data.address || schoolInfoData.address;
              schoolInfoData.phone = data.phone || schoolInfoData.phone;
              schoolInfoData.email = data.email || schoolInfoData.email;
              console.log("School info data loaded:", schoolInfoData);

              // Re-render school info section if it's currently active
              if (currentSection === "school-info") {
                renderSchoolInfoSection();
              }
            }
          })
          .catch((err) => {
            console.error("Error loading school info data:", err);
          });

        // Load contact data
        db.collection("settings")
          .doc("contact")
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              contactData.address = data.address || contactData.address;
              contactData.phone = data.phone || contactData.phone;
              contactData.email = data.email || contactData.email;
              contactData.hours = data.hours || contactData.hours;
              console.log("Contact data loaded:", contactData);

              // Re-render contact section if it's currently active
              if (currentSection === "contact") {
                renderContactSection();
              }
            }
          })
          .catch((err) => {
            console.error("Error loading contact data:", err);
          });

        // Load academics data
        db.collection("settings")
          .doc("academics")
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              academicsData.description =
                data.description || academicsData.description;
              academicsData.curriculum =
                data.curriculum || academicsData.curriculum;
              academicsData.programs = data.programs || academicsData.programs;
              academicsData.assessment =
                data.assessment || academicsData.assessment;
              academicsData.extracurricular =
                data.extracurricular || academicsData.extracurricular;
              console.log("Academics data loaded:", academicsData);

              // Re-render academics section if it's currently active
              if (currentSection === "academics") {
                renderAcademicsSection();
              }
            }
          })
          .catch((err) => {
            console.error("Error loading academics data:", err);
          });

        // Load logo data
        db.collection("settings")
          .doc("logo")
          .get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              logoData.logoUrl = data.logoUrl || logoData.logoUrl;
              logoData.schoolName = data.schoolName || logoData.schoolName;
              logoData.tagline = data.tagline || logoData.tagline;
              console.log("Logo data loaded:", logoData);

              // Re-render logo section if it's currently active
              if (currentSection === "logo") {
                renderLogoSection();
              }
            }
          })
          .catch((err) => {
            console.error("Error loading logo data:", err);
          });
      }

      function loadCollection(collection, dataArr, renderFn) {
        if (BYPASS_AUTH) {
          // In bypass mode, data is already loaded
          // Only render if current section matches
          if (currentSection === collection) {
            renderFn(collection);
          }
          return;
        }

        console.log(`Loading collection: ${collection}`);
        db.collection(collection)
          .get()
          .then((snapshot) => {
            console.log(`Loaded ${snapshot.size} documents from ${collection}`);
            dataArr.length = 0;
            snapshot.forEach((doc) => {
              let item = doc.data();
              item.id = doc.id;
              dataArr.push(item);
            });
            // Only render if current section matches
            if (currentSection === collection) {
              renderFn(collection);
            }
          })
          .catch((err) => {
            console.error("Error loading collection", collection, err);
            alert(`Failed to load ${collection} data: ${err.message}`);
            // Still render empty table to show UI, but only if section matches
            if (currentSection === collection) {
              renderFn(collection);
            }
          });
      }

      // Modern table renderer
      function renderTable(type) {
        let data, columns, tableId;
        if (type === "faculty") {
          data = facultyData;
          columns = ["name", "role", "description", "photo"];
          tableId = "faculty-table";
        } else if (type === "gallery") {
          data = galleryData;
          columns = ["src", "alt"];
          tableId = "gallery-table";
        } else if (type === "testimonials") {
          data = testimonialsData;
          columns = ["name", "role", "text"];
          tableId = "testimonials-table";
        } else if (type === "events") {
          data = eventsData;
          columns = ["title", "date", "validUntil", "category", "description"];
          tableId = "events-table";
        }

        // Safety check: Only render if the table container exists
        const tableContainer = document.getElementById(tableId);
        if (!tableContainer) {
          console.log(`Table container ${tableId} not found, skipping render`);
          return;
        }

        let html = '<table class="table"><thead><tr>';
        columns.forEach((col) => {
          let headerName = col.charAt(0).toUpperCase() + col.slice(1);
          if (col === "validUntil") headerName = "Valid Until";
          html += `<th>${headerName}</th>`;
        });
        html += "<th>Actions</th></tr></thead><tbody>";

        if (data.length === 0) {
          html += `<tr><td colspan="${
            columns.length + 1
          }" style="text-align:center;color:var(--text-secondary);padding:2rem;">
          No ${type} data available. Click "Add ${
            type.charAt(0).toUpperCase() + type.slice(1)
          }" to add new entries.
        </td></tr>`;
        } else {
          data.forEach((row, idx) => {
            html += "<tr>";
            columns.forEach((col) => {
              const value = row[col] || "";
              if (col === "photo" || (type === "gallery" && col === "src")) {
                html += `<td>
                <div class="form-group" style="margin:0;">
                  <input type="text" class="form-input" style="margin-bottom:0.5rem;" 
                         value="${value.replace(/"/g, "&quot;")}" 
                         onchange="updateCell('${type}',${idx},'${col}',this.value)" 
                         placeholder="Enter ${col} URL">
                  <input type="file" accept="image/*" class="form-input" style="font-size:0.75rem;padding:0.375rem;" 
                         onchange="uploadImage('${type}',${idx},'${col}',this)" title="Upload image">
                  <div id="progress-${type}-${idx}-${col}" class="progress-bar" style="display:none;">
                    <div class="progress-fill" style="width:0%"></div>
                  </div>
                  ${
                    value
                      ? `<img src="${value}" class="image-preview" style="margin-top:0.5rem;" onerror="this.style.display='none'">`
                      : ""
                  }
                </div>
              </td>`;
              } else if (col === "description" || col === "text") {
                html += `<td>
                <textarea class="form-input form-textarea" style="min-height:60px;" 
                          onchange="updateCell('${type}',${idx},'${col}',this.value)" 
                          placeholder="Enter ${col}">${value}</textarea>
              </td>`;
              } else if (col === "category" && type === "events") {
                html += `<td>
                <select class="form-input" onchange="updateCell('${type}',${idx},'${col}',this.value)">
                  <option value="urgent" ${
                    value === "urgent" ? "selected" : ""
                  }>🚨 Urgent</option>
                  <option value="academic" ${
                    value === "academic" ? "selected" : ""
                  }>🎓 Academic</option>
                  <option value="events" ${
                    value === "events" ? "selected" : ""
                  }>📅 Events</option>
                  <option value="general" ${
                    value === "general" ? "selected" : ""
                  }>ℹ️ General</option>
                </select>
              </td>`;
              } else if (col === "validUntil" && type === "events") {
                html += `<td>
                <input type="date" class="form-input" 
                       value="${value}" 
                       onchange="updateCell('${type}',${idx},'${col}',this.value)" 
                       placeholder="Valid until (optional)">
              </td>`;
              } else if (col === "date" && type === "events") {
                html += `<td>
                <input type="date" class="form-input" 
                       value="${value}" 
                       onchange="updateCell('${type}',${idx},'${col}',this.value)" 
                       placeholder="Published date">
              </td>`;
              } else {
                html += `<td>
                <input type="text" class="form-input" 
                       value="${value.replace(/"/g, "&quot;")}" 
                       onchange="updateCell('${type}',${idx},'${col}',this.value)" 
                       placeholder="Enter ${col}">
              </td>`;
              }
            });
            html += `<td>
            <button class="btn btn-danger btn-sm" onclick="deleteRow('${type}',${idx})">
              <span class="icon">🗑️</span>
              Delete
            </button>
          </td></tr>`;
          });
        }

        html += "</tbody></table>";
        tableContainer.innerHTML = html;
      }

      // Update cell and save to Firestore
      function updateCell(type, idx, col, val) {
        let dataArr = getDataArr(type);
        dataArr[idx][col] = val;
        saveRow(type, idx);
      }

      function saveRow(type, idx) {
        let dataArr = getDataArr(type);
        let data = Object.assign({}, dataArr[idx]);
        let id = data.id;
        delete data.id;

        if (BYPASS_AUTH) {
          // In local mode, just update the data array
          console.log(`Saved ${type} row ${idx} in local mode`);
          showSuccessIndicator(`${type}-${idx}`, "Saved locally");
          return;
        }

        if (id) {
          db.collection(type)
            .doc(id)
            .set(data)
            .then(() => {
              // Invalidate cache by updating timestamp
              invalidateCache(type);
              showSuccessIndicator(`${type}-${idx}`, "Saved to Firebase");
              loadCollection(type, dataArr, renderTable);
            })
            .catch((err) => {
              alert("Failed to save: " + err.message);
              console.error("Firestore set error:", err);
            });
        } else {
          db.collection(type)
            .add(data)
            .then((docRef) => {
              dataArr[idx].id = docRef.id;
              // Invalidate cache by updating timestamp
              invalidateCache(type);
              showSuccessIndicator(`${type}-${idx}`, "Added to Firebase");
              loadCollection(type, dataArr, renderTable);
            })
            .catch((err) => {
              alert("Failed to add: " + err.message);
              console.error("Firestore add error:", err);
            });
        }
      }

      function addRow(type) {
        let dataArr = getDataArr(type);
        let newRow;
        if (type === "faculty")
          newRow = { name: "", role: "", description: "", photo: "" };
        else if (type === "gallery") newRow = { src: "", alt: "" };
        else if (type === "testimonials")
          newRow = { name: "", role: "", text: "" };
        else if (type === "events")
          newRow = {
            title: "",
            date: "",
            validUntil: "",
            category: "general",
            description: "",
          };

        if (BYPASS_AUTH) {
          // In local mode, just add to array with a temporary ID
          newRow.id = Date.now().toString();
          dataArr.push(newRow);
          renderTable(type);
          console.log(`Added new ${type} row in local mode`);
          showSuccessIndicator(`${type}-new`, "Row added locally");
          return;
        }

        // Add to Firestore immediately
        db.collection(type)
          .add(newRow)
          .then((docRef) => {
            newRow.id = docRef.id;
            dataArr.push(newRow);
            // Invalidate cache by updating timestamp
            invalidateCache(type);
            renderTable(type);
            showSuccessIndicator(`${type}-new`, "Row added to Firebase");
          })
          .catch((err) => {
            alert("Failed to add new row: " + err.message);
            console.error("Firestore add error:", err);
          });
      }

      function deleteRow(type, idx) {
        let dataArr = getDataArr(type);
        let id = dataArr[idx].id;

        if (BYPASS_AUTH) {
          // In local mode, just remove from array
          dataArr.splice(idx, 1);
          renderTable(type);
          console.log(`Deleted ${type} row ${idx} in local mode`);
          showSuccessIndicator(`${type}-delete`, "Row deleted locally");
          return;
        }

        if (id) {
          db.collection(type)
            .doc(id)
            .delete()
            .then(() => {
              dataArr.splice(idx, 1);
              // Invalidate cache by updating timestamp
              invalidateCache(type);
              renderTable(type);
              showSuccessIndicator(
                `${type}-delete`,
                "Row deleted from Firebase"
              );
            })
            .catch((err) => {
              alert("Deletion failed: " + err.message);
              console.error("Firestore delete error:", err);
            });
        } else {
          dataArr.splice(idx, 1);
          renderTable(type);
          showSuccessIndicator(`${type}-delete`, "Row deleted");
        }
      }

      function getDataArr(type) {
        if (type === "faculty") return facultyData;
        if (type === "gallery") return galleryData;
        if (type === "testimonials") return testimonialsData;
        if (type === "events") return eventsData;
      }

      // Modern image upload
      function uploadImage(type, idx, col, input) {
        const file = input.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          alert("Please upload an image file.");
          input.value = "";
          return;
        }

        const progressId = `progress-${type}-${idx}-${col}`;
        const progressDiv = document.getElementById(progressId);
        const progressBar = progressDiv.querySelector(".progress-fill");

        // Always use local mode since Firebase Storage is disabled for free tier
        progressDiv.style.display = "block";
        input.disabled = true;

        // Simulate progress for better UX
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 30;
          if (progress > 100) progress = 100;
          progressBar.style.width = progress + "%";

          if (progress >= 100) {
            clearInterval(progressInterval);

            // Compress image if needed before processing
            compressImageIfNeeded(file, (compressedFile) => {
              const reader = new FileReader();
              reader.onload = function (e) {
                const imageUrl = e.target.result;
                updateCell(type, idx, col, imageUrl);

                const mode = BYPASS_AUTH ? "locally" : "as base64";
                const compressionMsg =
                  compressedFile !== file ? " (compressed)" : "";
                showSuccessIndicator(
                  `${type}-${idx}-upload`,
                  `Image uploaded ${mode}${compressionMsg}`
                );

                setTimeout(() => {
                  progressDiv.style.display = "none";
                  progressBar.style.width = "0%";
                  input.disabled = false;
                  input.value = "";
                }, 1000);
              };
              reader.readAsDataURL(compressedFile);
            });
          }
        }, 100);
      }

      // Image compression function with Firebase document size limit consideration
      function compressImageIfNeeded(file, callback) {
        // Firebase Firestore document limit is ~1MB, base64 adds ~33% overhead
        // So we need to keep final file size under ~700KB to account for base64 encoding
        const maxSize = 700 * 1024; // 700KB limit for Firebase compatibility

        console.log(
          `Processing image: ${(file.size / (1024 * 1024)).toFixed(1)}MB`
        );

        // Show compression notification
        showCompressionNotification("Processing image for Firebase...");

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();

        img.onload = function () {
          // Always compress for Firebase - even small images might become large when base64 encoded
          let { width, height } = calculateOptimalDimensions(
            img.width,
            img.height,
            file.size,
            maxSize
          );

          canvas.width = width;
          canvas.height = height;

          // Draw image with high quality rendering
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = "high";
          ctx.drawImage(img, 0, 0, width, height);

          // Try different quality levels until we get under the Firebase limit
          let quality = 0.85; // Start with higher quality
          let attempts = 0;
          const maxAttempts = 8; // More attempts for better optimization

          function tryCompress() {
            canvas.toBlob(
              function (blob) {
                // Check if the blob size is acceptable for Firebase (accounting for base64 overhead)
                const estimatedBase64Size = blob.size * 1.37; // Base64 overhead factor

                if (
                  blob.size <= maxSize ||
                  attempts >= maxAttempts ||
                  quality <= 0.1
                ) {
                  // Success or max attempts reached
                  const compressedFile = new File([blob], file.name, {
                    type: file.type,
                    lastModified: Date.now(),
                  });

                  const originalSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                  const compressedSizeKB = (compressedFile.size / 1024).toFixed(
                    0
                  );
                  const estimatedFirebaseSize = (
                    estimatedBase64Size / 1024
                  ).toFixed(0);

                  console.log(
                    `Image optimized: ${originalSizeMB}MB → ${compressedSizeKB}KB (Firebase: ~${estimatedFirebaseSize}KB)`
                  );

                  showCompressionNotification(
                    `Image optimized! ${originalSizeMB}MB → ${compressedSizeKB}KB`
                  );

                  setTimeout(() => {
                    hideCompressionNotification();
                    callback(compressedFile);
                  }, 1500);
                } else {
                  // Try with lower quality
                  attempts++;
                  quality -= 0.08; // Smaller decrements for better quality control
                  showCompressionNotification(
                    `Optimizing for Firebase... (${attempts}/${maxAttempts})`
                  );
                  tryCompress();
                }
              },
              "image/jpeg",
              quality
            ); // Force JPEG for better compression
          }

          tryCompress();
        };

        img.onerror = function () {
          console.error("Error loading image for compression");
          hideCompressionNotification();
          callback(file); // Return original file if compression fails
        };

        // Load image
        const reader = new FileReader();
        reader.onload = function (e) {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      // Show compression notification
      function showCompressionNotification(message) {
        let notification = document.getElementById("compression-notification");
        if (!notification) {
          notification = document.createElement("div");
          notification.id = "compression-notification";
          notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 15px 20px;
          border-radius: 10px;
          box-shadow: 0 6px 20px rgba(0,0,0,0.15);
          z-index: 10000;
          font-family: inherit;
          font-size: 14px;
          min-width: 250px;
          text-align: center;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s ease;
        `;
          document.body.appendChild(notification);
        }

        notification.textContent = message;

        // Show notification
        setTimeout(() => {
          notification.style.opacity = "1";
          notification.style.transform = "translateX(0)";
        }, 100);
      }

      // Hide compression notification
      function hideCompressionNotification() {
        const notification = document.getElementById(
          "compression-notification"
        );
        if (notification) {
          notification.style.opacity = "0";
          notification.style.transform = "translateX(100%)";
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }
      }

      // Calculate optimal dimensions for Firebase Firestore compatibility
      function calculateOptimalDimensions(
        originalWidth,
        originalHeight,
        originalSize,
        maxSize
      ) {
        // For Firebase, we need to be more aggressive with compression
        // Base64 encoding adds ~33% overhead, so target even smaller file sizes

        // Start with a more aggressive compression ratio
        let compressionRatio = Math.sqrt(maxSize / originalSize);

        // For very large images, be even more aggressive
        if (originalSize > 5 * 1024 * 1024) {
          // > 5MB
          compressionRatio *= 0.6; // Additional 40% reduction
        } else if (originalSize > 2 * 1024 * 1024) {
          // > 2MB
          compressionRatio *= 0.75; // Additional 25% reduction
        }

        // Apply compression ratio to dimensions
        let width = Math.floor(originalWidth * compressionRatio);
        let height = Math.floor(originalHeight * compressionRatio);

        // Set reasonable bounds for web display
        const minDimension = 150; // Minimum for usability
        const maxDimension = 1200; // Maximum for Firebase efficiency

        // Ensure minimum dimensions
        if (width < minDimension || height < minDimension) {
          const scale = minDimension / Math.min(width, height);
          width = Math.floor(width * scale);
          height = Math.floor(height * scale);
        }

        // Ensure maximum dimensions for Firebase
        if (width > maxDimension || height > maxDimension) {
          const scale = maxDimension / Math.max(width, height);
          width = Math.floor(width * scale);
          height = Math.floor(height * scale);
        }

        // For hero background images, optimize for typical web display
        const aspectRatio = originalWidth / originalHeight;
        if (aspectRatio > 2) {
          // Wide landscape images (typical for hero banners)
          width = Math.min(width, 1200);
          height = Math.floor(width / aspectRatio);
        }

        console.log(
          `Dimension optimization: ${originalWidth}x${originalHeight} → ${width}x${height}`
        );

        return { width, height };
      }

      // Modern success indicator
      function showSuccessIndicator(id, message) {
        // Create success indicator with unique ID
        const indicatorId = `success-${Date.now()}`;
        const indicator = document.createElement("div");
        indicator.id = indicatorId;
        indicator.className = "success-toast";
        indicator.textContent = message;

        // Add to body for fixed positioning
        document.body.appendChild(indicator);

        // Show with animation
        setTimeout(() => {
          indicator.classList.add("show");
        }, 10);

        // Hide after 3 seconds and remove
        setTimeout(() => {
          indicator.classList.remove("show");
          setTimeout(() => {
            if (indicator && indicator.parentNode) {
              indicator.parentNode.removeChild(indicator);
            }
          }, 300);
        }, 3000);
      }

      // Logout function
      function logout() {
        if (BYPASS_AUTH) {
          alert("Logout is not available in local mode");
          return;
        }

        auth.signOut().catch((err) => {
          alert("Logout failed: " + err.message);
          console.error("Sign out error:", err);
        });
      }

      // Modern login function
      function login() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const statusDiv = document.getElementById("login-status");

        if (!email || !password) {
          statusDiv.className = "login-status error";
          statusDiv.textContent = "Please enter both email and password";
          statusDiv.style.display = "block";
          return;
        }

        statusDiv.className = "login-status loading";
        statusDiv.textContent = "Signing in...";
        statusDiv.style.display = "block";

        auth
          .signInWithEmailAndPassword(email, password)
          .then(function (userCredential) {
            console.log("Login successful:", userCredential.user.email);
            statusDiv.className = "login-status success";
            statusDiv.textContent = "Login successful! Redirecting...";

            setTimeout(() => {
              showAdminPanel(userCredential.user);
            }, 1000);
          })
          .catch(function (error) {
            console.error("Firebase login error:", error);
            statusDiv.className = "login-status error";

            let errorMessage = "Login failed: ";
            if (error.code === "auth/user-not-found") {
              errorMessage += "User not found. Please contact administrator.";
            } else if (error.code === "auth/wrong-password") {
              errorMessage += "Incorrect password.";
            } else if (error.code === "auth/invalid-email") {
              errorMessage += "Invalid email format.";
            } else {
              errorMessage += error.message;
            }

            statusDiv.textContent = errorMessage;
          });
      }

      // Show admin panel after login
      function showAdminPanel(user) {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("admin-app").style.display = "flex";

        // Update mode badge and user info
        const modeBadge = document.getElementById("mode-badge");
        modeBadge.textContent = BYPASS_AUTH ? "Local Mode" : "Firebase Mode";
        modeBadge.className = BYPASS_AUTH ? "mode-badge local" : "mode-badge";

        document.getElementById("user-email").textContent = BYPASS_AUTH
          ? "Local Mode"
          : user.email;

        // Load all data and show first section
        loadAllData();
        loadSettingsData();
        showSection("faculty");
      }

      // Initial setup
      if (BYPASS_AUTH) {
        // Skip authentication in bypass mode
        console.log("Bypass mode enabled - showing admin interface");
        setTimeout(() => {
          showAdminPanel({ email: "Local Mode" });
        }, 100);
      } else {
        document.getElementById("mode-badge").textContent = "Firebase Mode";
        auth.onAuthStateChanged(function (user) {
          if (user) {
            console.log("User authenticated:", user.email);
            showAdminPanel(user);

            // Initialize sample data if needed, then load all data
            initializeSampleData();
            setTimeout(() => {
              loadAllData();
              loadSettingsData();
            }, 1000);
          } else {
            document.getElementById("login-screen").style.display = "flex";
            document.getElementById("admin-app").style.display = "none";
          }
        });
      }

      // Add keyboard support for login
      document.addEventListener("DOMContentLoaded", function () {
        const emailInput = document.getElementById("login-email");
        const passwordInput = document.getElementById("login-password");

        if (emailInput && passwordInput) {
          emailInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              passwordInput.focus();
            }
          });

          passwordInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              login();
            }
          });
        }
      });

      // Logout function
      function logout() {
        if (BYPASS_AUTH) {
          location.reload();
        } else {
          auth
            .signOut()
            .then(function () {
              console.log("Logout successful");
              location.reload();
            })
            .catch(function (error) {
              console.error("Logout error:", error);
            });
        }
      }

      // Mobile menu toggle
      function toggleMobileMenu() {
        const mobileOverlay = document.getElementById("mobile-overlay");
        mobileOverlay.classList.toggle("show");
      }

      // Initialize after DOM load
      document.addEventListener("DOMContentLoaded", function () {
        // Set up mobile overlay click handler
        const mobileOverlay = document.getElementById("mobile-overlay");
        mobileOverlay.addEventListener("click", function (e) {
          if (e.target === mobileOverlay) {
            toggleMobileMenu();
          }
        });

        // Set up section navigation
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", function () {
            const section = this.getAttribute("data-section");
            showSection(section);
            // Close mobile menu if open
            document.getElementById("mobile-overlay").classList.remove("show");
          });
        });

        // Set up logout button
        document.getElementById("logout-btn").addEventListener("click", logout);

        // Set up mobile menu button
        document
          .getElementById("mobile-menu-btn")
          .addEventListener("click", toggleMobileMenu);

        // Form submission handlers
        document
          .getElementById("login-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            login();
          });
      });

      // Login function
      function login() {
        var email = document.getElementById("login-email").value;
        var password = document.getElementById("login-password").value;

        if (!email || !password) {
          alert("Please enter both email and password");
          return;
        }

        document.getElementById("login-status").innerHTML = "Logging in...";

        auth
          .signInWithEmailAndPassword(email, password)
          .then(function (userCredential) {
            console.log("Login successful:", userCredential.user.email);
            document.getElementById("login-status").innerHTML =
              "Login successful!";
          })
          .catch(function (error) {
            console.error("Firebase login error:", error);
            document.getElementById(
              "login-status"
            ).innerHTML = `Login failed: ${error.message}`;

            if (error.code === "auth/user-not-found") {
              document.getElementById("login-status").innerHTML +=
                "<br>User not found. Please contact administrator.";
            } else if (error.code === "auth/wrong-password") {
              document.getElementById("login-status").innerHTML +=
                "<br>Incorrect password.";
            } else if (error.code === "auth/invalid-email") {
              document.getElementById("login-status").innerHTML +=
                "<br>Invalid email format.";
            }
          });
      }

      // Notice Board Import/Export Functions
      function exportNotices() {
        const dataToExport = {
          notices: eventsData,
          exportDate: new Date().toISOString(),
          version: "1.0",
        };

        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
          type: "application/json",
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `notices-export-${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSuccessIndicator(
          "export-notices",
          "Notices exported successfully!"
        );
      }

      function importNotices(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);

            if (!data.notices || !Array.isArray(data.notices)) {
              alert(
                "Invalid file format. Please select a valid notices export file."
              );
              return;
            }

            // Validate notice structure
            const validNotices = data.notices.filter((notice) => {
              return (
                notice.title &&
                notice.category &&
                ["urgent", "academic", "events", "general"].includes(
                  notice.category
                )
              );
            });

            if (validNotices.length === 0) {
              alert("No valid notices found in the file.");
              return;
            }

            // Confirm import
            const confirmMsg = `Found ${validNotices.length} valid notices to import. This will replace existing notices. Continue?`;
            if (!confirm(confirmMsg)) return;

            // Import notices
            eventsData.length = 0; // Clear existing data
            validNotices.forEach((notice, index) => {
              notice.id = Date.now() + index; // Generate new IDs
              eventsData.push(notice);
            });

            // Save to Firebase if not in bypass mode
            if (!BYPASS_AUTH) {
              // Clear existing collection and add new data
              const batch = db.batch();

              // Note: In a real implementation, you'd want to delete existing docs first
              validNotices.forEach((notice) => {
                const docRef = db.collection("events").doc();
                const noticeData = { ...notice };
                delete noticeData.id;
                batch.set(docRef, noticeData);
              });

              batch
                .commit()
                .then(() => {
                  renderEventsSection(); // Refresh the UI
                  showSuccessIndicator(
                    "import-notices",
                    `${validNotices.length} notices imported successfully!`
                  );
                })
                .catch((err) => {
                  console.error("Import error:", err);
                  alert("Error saving to Firebase: " + err.message);
                });
            } else {
              renderEventsSection(); // Refresh the UI
              showSuccessIndicator(
                "import-notices",
                `${validNotices.length} notices imported successfully!`
              );
            }
          } catch (error) {
            console.error("Import error:", error);
            alert("Error reading file: " + error.message);
          } finally {
            // Clear the file input
            event.target.value = "";
          }
        };

        reader.readAsText(file);
      }
    </script>
  </body>
</html>
