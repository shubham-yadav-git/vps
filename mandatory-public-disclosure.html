<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    /* Responsive Disclosure Table Styles */
    .mpd-section {
      margin-bottom: 2.5rem;
    }
    .mpd-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 2px #f1f5f9;
      overflow-x: auto;
      font-size: 1.05em;
      margin-bottom: 0.5em;
    }
    .mpd-table th, .mpd-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      min-width: 90px;
      word-break: break-word;
    }
    .mpd-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
    }
    .mpd-table tr:last-child td {
      border-bottom: none;
    }
    @media (max-width: 700px) {
      .container {
        padding: 1rem 0.2rem !important;
      }
      .main-title {
        font-size: 1.3rem !important;
      }
      .subtitle {
        font-size: 1.05rem !important;
      }
      .mpd-section h2 {
        font-size: 1.1rem !important;
        margin-bottom: 0.7em;
      }
      .mpd-table {
        font-size: 0.98em;
        border-radius: 6px;
      }
      .mpd-table th, .mpd-table td {
        padding: 7px 6px;
        font-size: 0.97em;
        min-width: 80px;
      }
      .mpd-section {
        margin-bottom: 1.3rem;
      }
      .header-container, .logo-section, .header-actions {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5em !important;
      }
      .logo-img {
        max-width: 48px !important;
        height: auto !important;
      }
      .school-name {
        font-size: 1.1rem !important;
      }
      .school-tagline {
        font-size: 0.95rem !important;
      }
      .btn-modern {
        font-size: 0.98rem !important;
        padding: 7px 14px !important;
      }
      .notice-ticker-bar, .notice-panel {
        font-size: 0.97em !important;
      }
    }
    /* Make tables horizontally scrollable on mobile */
    .mpd-table {
      display: block;
      overflow-x: auto;
      width: 100%;
      max-width: 100vw;
    }
    .mpd-table thead, .mpd-table tbody, .mpd-table tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    @media (max-width: 500px) {
      .mpd-table th, .mpd-table td {
        font-size: 0.93em;
        min-width: 70px;
        padding: 6px 4px;
      }
      .main-title {
        font-size: 1.05rem !important;
      }
    }
  </style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mandatory Public Disclosure | Vikas Public School</title>
  <meta name="description" content="Mandatory Public Disclosure as per CBSE requirements for Vikas Public School." />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="stylesheet" href="css/style.css?v=1.1" />
  <!-- Font Awesome for social icons in footer -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- GSAP & ScrollTrigger CDN for animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
</head>

<style>
  html, body { margin: 0; padding: 0; }
</style>

  <!-- Reading Progress Bar (required for main.js) -->
  <div id="reading-progress" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 3px;
    background: var(--primary-color);
    z-index: 9999;
    transition: width 0.3s ease;
  "></div>
<body>



  <!-- Sticky Top Bar styled like index.html navbar, but only logo and Back button -->
  <header>
    <div class="header-container">
      <div class="logo-section">
        <img src="assets/logo.png" alt="Vikas Public School Logo" class="logo-img" aria-hidden="false" aria-label="School Logo" loading="eager" fetchpriority="high" />
        <div class="logo-text">
          <h1 class="school-name">Vikas Public School</h1>
          <p class="school-tagline">Excellence in Education</p>
        </div>
      </div>
      <!-- No nav bar, just logo and back button -->
      <div class="header-actions">
        <a href="index.html#about" class="btn-modern">
          <span style="font-size:1.1em;">&#8592;</span> Back to About
        </a>
      </div>
    </div>
  </header>





  <!-- Notice Ticker Bar (copied from index.html) -->
  <div class="notice-ticker-bar" id="notice-ticker-bar">
    <div class="notice-ticker-container">
      <div class="notice-bell-icon" onclick="toggleNoticePanel()">
        <div class="bell-icon">üîî</div>
        <div class="notice-count-badge" id="notice-count-badge">0</div>
      </div>
      <div class="notice-ticker-content">
        <div class="notice-ticker-text" id="notice-ticker-text">
          <span class="ticker-item">üìå Loading latest notices...</span>
        </div>
      </div>
      <div class="notice-view-all" onclick="toggleNoticePanel()">
        View All
      </div>
    </div>
  </div>

  <!-- Notice Panel (Collapsible, copied from index.html) -->
  <div class="notice-panel" id="notice-panel">
    <div class="notice-panel-header">
      <h3>üìå School Notice Board</h3>
      <button class="notice-panel-close" onclick="toggleNoticePanel()">‚úï</button>
    </div>
    <div class="notice-panel-content" id="notice-panel-content">
      <div class="notice-loading">Loading notices...</div>
    </div>
  </div>



  <main class="container" style="max-width: 1100px; margin: 0 auto; padding: 2rem 1rem;">
    <h1 class="main-title" style="color: var(--primary-color);">Mandatory Public Disclosure</h1>
    <p class="subtitle">(As per CBSE requirements)</p>

    <!-- Dynamic Disclosure Sections Rendered Here -->
    <div id="disclosure-sections"></div>
  <!-- Dynamic Disclosure Sections Loader -->
  <script>
    // DEBUG: Confirm script is loaded
    console.log('MPD script loaded');
    // Wait for Firebase and DOM
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded fired');
      function renderDisclosureSections(sections) {
        const container = document.getElementById('disclosure-sections');
        if (!container) return;
        container.innerHTML = '';
        if (!Array.isArray(sections) || sections.length === 0) {
          container.innerHTML = '<div style="color:#888;font-size:1.1em;margin:2em 0;">No disclosure data available.<br><pre id="disclosure-debug"></pre></div>';
          return;
        }
        sections.filter(s => s.enabled !== false).forEach(section => {
          // Robustly convert rows from objects to arrays if needed (like admin)
          let fields = Array.isArray(section.fields) ? section.fields : [];
          let rows = Array.isArray(section.rows) ? section.rows : [];
          if (fields.length && rows.length && typeof rows[0] === 'object' && !Array.isArray(rows[0])) {
            // Convert objects to arrays in field order
            const fieldLabels = fields.map(f => f.label || "");
            rows = rows.map(obj => fieldLabels.map(label => obj[label || ""] || ""));
          }
          // Table header
          let tableHeader = '<tr>';
          fields.forEach(f => {
            tableHeader += `<th>${f.label||''}</th>`;
          });
          tableHeader += '</tr>';
          // Table body
          let tableBody = '';
          rows.forEach(row => {
            tableBody += '<tr>';
            fields.forEach((f, idx) => {
              let val = Array.isArray(row) ? row[idx] : (row[f.label||'']||'');
              // Check if the field is a file field and value starts with data:
              const isFileField = f.type === 'file';
              if (isFileField && val && (val.startsWith('data:') || val.startsWith('http'))) {
                // Determine file type for icon selection
                let fileIcon = 'üìÑ';
                let fileType = 'File';
                
                if (val.includes('data:image/')) {
                  fileIcon = 'üñºÔ∏è';
                  fileType = 'Image';
                } else if (val.includes('data:application/pdf') || val.toLowerCase().endsWith('.pdf')) {
                  fileIcon = 'üìë';
                  fileType = 'PDF';
                } else if (val.includes('data:text/')) {
                  fileIcon = 'üìù';
                  fileType = 'Document';
                }
                
                // For PDFs, create a special handler that will prevent direct navigation
                if (fileType === 'PDF') {
                  tableBody += `<td>
                    <a href="#" data-file-url="${encodeURIComponent(val)}" class="pdf-viewer-link" style="display:inline-flex;align-items:center;gap:5px;text-decoration:none;color:#1d4ed8;font-weight:500;cursor:pointer;">
                      <span style="font-size:1.2em;">${fileIcon}</span>
                      <span>View ${fileType}</span>
                    </a>
                  </td>`;
                } else {
                  tableBody += `<td>
                    <a href="${val}" class="file-viewer-link" style="display:inline-flex;align-items:center;gap:5px;text-decoration:none;color:#1d4ed8;font-weight:500;cursor:pointer;">
                      <span style="font-size:1.2em;">${fileIcon}</span>
                      <span>View ${fileType}</span>
                    </a>
                  </td>`;
                }
              } else {
                tableBody += `<td>${val||''}</td>`;
              }
            });
            tableBody += '</tr>';
          });
          // Section title and table
          container.innerHTML += `
            <section class="mpd-section" style="margin-bottom:2.5rem;">
              <h2>${section.label||''}</h2>
              <table class="mpd-table">
                <thead>${tableHeader}</thead>
                <tbody>${tableBody}</tbody>
              </table>
            </section>
          `;
        });
      }

      // Fetch all disclosure sections from Firestore
      function fetchDisclosureSections() {
        console.log('Fetching disclosure sections...');
        if (!window.db) {
          document.getElementById('disclosure-sections').innerHTML = '<div style="color:#888;font-size:1.1em;margin:2em 0;">Database not available.</div>';
          return;
        }
        window.db.collection('settings').doc('disclosure').get().then(doc => {
          let data = doc.exists ? doc.data() : {};
          let sections = Array.isArray(data.sections) ? data.sections : [];
          console.log('[MPD] Disclosure sections count:', sections.length, sections);
          // Debug: show raw data if nothing renders
          if ((!sections || !sections.length) && document.getElementById('disclosure-debug')) {
            document.getElementById('disclosure-debug').textContent = JSON.stringify(data, null, 2);
          }
          renderDisclosureSections(sections);
        }).catch(err => {
          document.getElementById('disclosure-sections').innerHTML = '<div style="color:#c00;font-size:1.1em;margin:2em 0;">Failed to load disclosure data.</div>';
        });
      }

      // Wait for window.db to be available before fetching
      function waitForDbAndFetch(attempts = 0) {
        if (window.db) {
          fetchDisclosureSections();
        } else if (attempts < 50) {
          setTimeout(() => waitForDbAndFetch(attempts + 1), 100);
        } else {
          console.error('window.db not available after waiting.');
        }
      }
      waitForDbAndFetch();
    });
  </script>
  </main>

  <!-- Footer (copy from index.html for consistency) -->
  <!-- Common Footer Include -->
  <div id="footer-include"></div>
  <script>
    // Simple HTML include for static hosting
    fetch('assets/footer.html')
      .then(r => r.text())
      .then(html => { document.getElementById('footer-include').innerHTML = html; });
  </script>
  <!-- GSAP Animation for MPD sections -->
  <script src="js/mpd-animate.js"></script>
  
  <!-- Modal for displaying files -->
  <script src="js/mpd-modal.js"></script>

  <!-- Firebase SDKs (from index.html) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Main JS -->
  <script src="js/main.js"></script>

  <!-- Firebase Config and Notice Loader (from index.html) -->
  <script>
    // Firebase configuration for free tier
    const firebaseConfig = {
      apiKey: "AIzaSyDZH0ZcGAtrILqdRdI5dIhZCUA0eAJzRpE",
      authDomain: "vpschool-918d6.firebaseapp.com",
      projectId: "vpschool-918d6",
      storageBucket: "vpschool-918d6.firebasestorage.app",
      messagingSenderId: "290237090155",
      appId: "1:290237090155:web:90356cb12d25d5a0a8a42e",
      measurementId: "G-02JK84S8NH"
    };
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof firebase !== 'undefined') {
        try {
          firebase.initializeApp(firebaseConfig);
          window.db = firebase.firestore();
        } catch (e) {
          window.db = firebase.firestore();
        }
      }
      // Notice system will auto-initialize from main.js
    });
  </script>
</body>
</html>
